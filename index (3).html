<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gesti√≥n de Actas de Reuni√≥n</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=DM+Sans:wght@300;400;500;600&display=swap');
  :root {
    --navy:#0F1B4C; --navy-mid:#1A2E6E; --blue:#2B4BA8;
    --accent:#C5A84F; --accent-light:#E8D08A;
    --white:#FFF; --off-white:#F7F8FC; --gray-light:#E8EBF4;
    --gray:#8C93AD; --text:#1A1F36; --danger:#C0392B; --success:#1A7A4A;
    --shadow:0 4px 24px rgba(15,27,76,.10); --shadow-lg:0 12px 48px rgba(15,27,76,.18);
  }
  *{box-sizing:border-box;margin:0;padding:0}
  body{font-family:'DM Sans',sans-serif;background:var(--navy);color:var(--text);min-height:100vh}

  /* LOGIN */
  #login-screen{min-height:100vh;display:flex;align-items:center;justify-content:center;
    background:linear-gradient(135deg,var(--navy) 0%,var(--navy-mid) 60%,#0D2550 100%);
    position:relative;overflow:hidden}
  #login-screen::before{content:'';position:absolute;width:600px;height:600px;border-radius:50%;
    background:radial-gradient(circle,rgba(197,168,79,.08) 0%,transparent 70%);top:-150px;right:-150px}
  #login-screen::after{content:'';position:absolute;width:400px;height:400px;border-radius:50%;
    background:radial-gradient(circle,rgba(43,75,168,.15) 0%,transparent 70%);bottom:-100px;left:-100px}
  .login-card{background:rgba(255,255,255,.04);backdrop-filter:blur(20px);
    border:1px solid rgba(197,168,79,.2);border-radius:20px;padding:52px 48px;
    width:100%;max-width:420px;position:relative;z-index:1;box-shadow:var(--shadow-lg);animation:fadeUp .6s ease}
  .login-logo{text-align:center;margin-bottom:36px}
  .login-logo .icon{width:64px;height:64px;background:linear-gradient(135deg,var(--accent),var(--accent-light));
    border-radius:16px;display:inline-flex;align-items:center;justify-content:center;
    font-size:28px;margin-bottom:16px;box-shadow:0 8px 24px rgba(197,168,79,.3)}
  .login-logo h1{font-family:'Playfair Display',serif;font-size:22px;color:var(--white);font-weight:600}
  .login-logo p{color:var(--gray);font-size:13px;margin-top:4px}
  .form-group{margin-bottom:20px}
  .form-group label{display:block;font-size:12px;font-weight:600;letter-spacing:1px;
    text-transform:uppercase;color:var(--accent-light);margin-bottom:8px}
  .form-group input,.form-group select,.form-group textarea{
    width:100%;padding:12px 16px;border-radius:10px;border:1px solid rgba(255,255,255,.1);
    background:rgba(255,255,255,.07);color:var(--white);font-family:'DM Sans',sans-serif;
    font-size:15px;transition:all .2s;outline:none}
  .form-group input::placeholder{color:rgba(255,255,255,.3)}
  .form-group input:focus{border-color:var(--accent);background:rgba(255,255,255,.1);box-shadow:0 0 0 3px rgba(197,168,79,.15)}
  .error-msg{background:rgba(192,57,43,.15);border:1px solid rgba(192,57,43,.4);
    color:#FF8A80;padding:10px 14px;border-radius:8px;font-size:13px;margin-bottom:16px;display:none}

  /* BUTTONS */
  .btn{display:inline-flex;align-items:center;gap:8px;padding:11px 22px;border-radius:10px;
    border:none;font-family:'DM Sans',sans-serif;font-size:14px;font-weight:600;cursor:pointer;
    transition:all .2s;text-decoration:none}
  .btn-primary{background:linear-gradient(135deg,var(--accent),#A8892E);color:var(--navy);
    width:100%;justify-content:center;padding:14px;font-size:15px;box-shadow:0 4px 16px rgba(197,168,79,.3)}
  .btn-primary:hover{transform:translateY(-1px);box-shadow:0 8px 24px rgba(197,168,79,.4)}
  .btn-secondary{background:rgba(255,255,255,.08);color:var(--white);border:1px solid rgba(255,255,255,.15)}
  .btn-secondary:hover{background:rgba(255,255,255,.14)}
  .btn-blue{background:var(--blue);color:var(--white);box-shadow:0 4px 12px rgba(43,75,168,.3)}
  .btn-blue:hover{background:var(--navy-mid);transform:translateY(-1px)}
  .btn-danger{background:rgba(192,57,43,.15);color:#FF6B6B;border:1px solid rgba(192,57,43,.3)}
  .btn-danger:hover{background:rgba(192,57,43,.25)}
  .btn-sm{padding:7px 14px;font-size:13px}
  .btn-success{background:linear-gradient(135deg,var(--success),#155D38);color:white;box-shadow:0 4px 12px rgba(26,122,74,.3)}
  .btn-ai{background:linear-gradient(135deg,#6B21A8,#4C1D95);color:white;box-shadow:0 4px 12px rgba(107,33,168,.35)}
  .btn-ai:hover{background:linear-gradient(135deg,#7C3AED,#5B21B6);transform:translateY(-1px)}

  /* APP */
  #app{display:none;min-height:100vh;background:var(--off-white)}
  .topbar{background:var(--navy);padding:0 32px;height:64px;display:flex;align-items:center;
    justify-content:space-between;position:sticky;top:0;z-index:100;box-shadow:0 2px 20px rgba(0,0,0,.2)}
  .topbar-brand{display:flex;align-items:center;gap:12px}
  .topbar-brand .icon{width:36px;height:36px;background:linear-gradient(135deg,var(--accent),var(--accent-light));
    border-radius:9px;display:flex;align-items:center;justify-content:center;font-size:16px}
  .topbar-brand h2{font-family:'Playfair Display',serif;font-size:18px;color:var(--white);font-weight:600}
  .topbar-right{display:flex;align-items:center;gap:16px}
  .user-badge{background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.12);
    color:var(--gray-light);padding:6px 14px;border-radius:20px;font-size:13px;display:flex;align-items:center;gap:8px}
  .tabs{display:flex;background:var(--navy-mid);padding:0 32px;gap:4px;border-bottom:1px solid rgba(255,255,255,.06)}
  .tab-btn{padding:14px 22px;background:none;border:none;color:var(--gray);font-family:'DM Sans',sans-serif;
    font-size:14px;font-weight:500;cursor:pointer;border-bottom:2px solid transparent;
    transition:all .2s;display:flex;align-items:center;gap:8px}
  .tab-btn:hover{color:var(--white)}
  .tab-btn.active{color:var(--accent-light);border-bottom-color:var(--accent)}
  .main-content{max-width:900px;margin:0 auto;padding:36px 24px}
  .section-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:28px}
  .section-header h2{font-family:'Playfair Display',serif;font-size:26px;color:var(--navy);font-weight:700}
  .section-header p{color:var(--gray);font-size:14px;margin-top:4px}

  /* CARD */
  .card{background:var(--white);border-radius:16px;padding:32px;box-shadow:var(--shadow);
    margin-bottom:24px;border:1px solid var(--gray-light)}
  .card-title{font-family:'Playfair Display',serif;font-size:17px;color:var(--navy);font-weight:600;
    margin-bottom:22px;padding-bottom:14px;border-bottom:2px solid var(--gray-light);
    display:flex;align-items:center;gap:10px}
  .card-title .dot{width:10px;height:10px;background:var(--accent);border-radius:50%}

  /* APP FORM */
  .app-form .form-group label{color:var(--navy);font-size:12px}
  .app-form .form-group input,.app-form .form-group select,.app-form .form-group textarea{
    background:var(--off-white);color:var(--text);border:1px solid var(--gray-light)}
  .app-form .form-group input::placeholder,.app-form .form-group textarea::placeholder{color:var(--gray)}
  .app-form .form-group input:focus,.app-form .form-group select:focus,.app-form .form-group textarea:focus{
    border-color:var(--blue);background:white;box-shadow:0 0 0 3px rgba(43,75,168,.08);color:var(--text)}
  .app-form .form-group select option{background:white;color:var(--text)}
  .form-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
  .form-grid.three{grid-template-columns:1fr 1fr 1fr}
  .span-2{grid-column:span 2}
  textarea{resize:vertical;min-height:90px}
  .field-readonly{background:#F0F2FA!important;color:#555!important;border:1px solid #D0D5E8!important;cursor:default;font-weight:500}

  /* DOCENTES CHECKBOXES */
  .docentes-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:12px}
  .docente-check{display:flex;align-items:center;gap:10px;background:var(--off-white);
    border:1px solid var(--gray-light);border-radius:10px;padding:10px 14px;
    cursor:pointer;transition:all .2s;user-select:none}
  .docente-check:hover{border-color:var(--blue);background:#EEF1FB}
  .docente-check.selected{border-color:var(--blue);background:#EEF1FB}
  .docente-check input[type=checkbox]{accent-color:var(--blue);width:16px;height:16px;flex-shrink:0}
  .docente-check span{font-size:13.5px;color:var(--text);font-weight:500}

  /* COMPROMISOS */
  .compromiso-card{background:var(--off-white);border:1px solid var(--gray-light);
    border-radius:12px;padding:20px;margin-bottom:14px;animation:fadeIn .25s ease}
  .compromiso-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px}
  .compromiso-num{background:var(--navy);color:var(--accent-light);font-size:11px;font-weight:700;
    padding:3px 10px;border-radius:20px;letter-spacing:.5px;text-transform:uppercase}
  .remove-btn{background:none;border:none;color:var(--gray);cursor:pointer;font-size:18px;
    padding:2px 6px;border-radius:6px;transition:all .2s}
  .remove-btn:hover{color:var(--danger);background:rgba(192,57,43,.08)}

  /* IA */
  .ai-loading{display:none;align-items:center;gap:10px;background:#F3E8FF;
    border:1px solid #C4B5FD;border-radius:10px;padding:12px 16px;margin-top:10px;
    font-size:13px;color:#6B21A8}
  .ai-loading.show{display:flex}
  .ai-spinner{width:18px;height:18px;border:2px solid #C4B5FD;border-top-color:#6B21A8;
    border-radius:50%;animation:spin .8s linear infinite}
  @keyframes spin{to{transform:rotate(360deg)}}
  .ai-result{display:none;background:#F0FDF4;border:1px solid #86EFAC;border-radius:10px;
    padding:14px 16px;margin-top:10px;font-size:13.5px;color:#14532D;line-height:1.65;white-space:pre-wrap}
  .ai-result.show{display:block}
  .ai-result-actions{display:flex;gap:8px;margin-top:10px}

  /* DESARROLLO ‚Äî 3 paneles */
  .dev-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
  .dev-panel{background:var(--off-white);border:1px solid var(--gray-light);border-radius:14px;padding:20px}
  .dev-panel-notas{border-top:3px solid var(--blue)}
  .dev-panel-rec{border-top:3px solid #DC2626}
  .dev-panel-final{border-top:3px solid #6B21A8;background:#FAF5FF}
  .dev-panel-title{font-family:'Playfair Display',serif;font-size:15px;color:var(--navy);
    font-weight:600;margin-bottom:6px}
  .dev-panel-desc{font-size:12.5px;color:var(--gray);margin-bottom:14px;line-height:1.5}
  .btn-unificar{background:linear-gradient(135deg,#6B21A8,#4C1D95);color:white;
    box-shadow:0 4px 12px rgba(107,33,168,.35);font-size:13px;padding:9px 18px;border-radius:10px;
    border:none;font-family:'DM Sans',sans-serif;font-weight:600;cursor:pointer;
    display:inline-flex;align-items:center;gap:7px;transition:all .2s}
  .btn-unificar:hover{transform:translateY(-1px);box-shadow:0 6px 18px rgba(107,33,168,.45)}
  @media(max-width:640px){.dev-grid{grid-template-columns:1fr}}
  .texto-aprobado-header{font-size:12px;font-weight:700;color:#14532D;letter-spacing:.5px;
    text-transform:uppercase;margin-bottom:6px;display:flex;align-items:center;gap:6px}
  .texto-aprobado-box{background:#F0FDF4;border:1px solid #86EFAC;border-radius:10px;
    padding:14px 16px;font-size:12.5px;color:#14532D;line-height:1.65;white-space:pre-wrap;
    max-height:220px;overflow-y:auto}
  .segmentos-contador-box{background:#EFF6FF;border:1px solid #BFDBFE;border-radius:10px;
    padding:10px 14px;font-size:12.5px;color:#1E40AF;font-weight:500;line-height:1.5}
  .seg-item{display:flex;align-items:center;gap:8px;padding:3px 0;border-bottom:1px solid #DBEAFE}
  .seg-item:last-child{border-bottom:none}
  .seg-badge{background:#1E40AF;color:white;font-size:10px;font-weight:700;padding:2px 7px;
    border-radius:10px;flex-shrink:0}

  /* GRABADOR DE VOZ */
  .rec-panel{background:#FFF8F8;border:1px solid #FECACA;border-radius:14px;padding:18px 20px;margin-bottom:14px}
  .rec-bar{display:flex;align-items:center;gap:10px;flex-wrap:wrap;margin-bottom:10px}
  .btn-rec{color:white;font-size:13px;padding:9px 18px;border-radius:10px;
    border:none;font-family:'DM Sans',sans-serif;font-weight:600;cursor:pointer;
    display:inline-flex;align-items:center;gap:7px;transition:all .2s}
  .btn-rec:disabled{opacity:.5;cursor:not-allowed;transform:none!important}
  .btn-rec-start{background:linear-gradient(135deg,#DC2626,#991B1B);box-shadow:0 4px 12px rgba(220,38,38,.35)}
  .btn-rec-start:hover:not(:disabled){transform:translateY(-1px);box-shadow:0 6px 18px rgba(220,38,38,.45)}
  .btn-rec-start.grabando{animation:pulseRec 1.4s ease-in-out infinite}
  .btn-rec-pause{background:linear-gradient(135deg,#D97706,#92400E);box-shadow:0 4px 12px rgba(217,119,6,.35)}
  .btn-rec-pause:hover:not(:disabled){transform:translateY(-1px);box-shadow:0 6px 18px rgba(217,119,6,.45)}
  .btn-rec-stop{background:linear-gradient(135deg,#1A7A4A,#14532D);box-shadow:0 4px 12px rgba(26,122,74,.35)}
  .btn-rec-stop:hover:not(:disabled){transform:translateY(-1px);box-shadow:0 6px 18px rgba(26,122,74,.45)}
  @keyframes pulseRec{0%,100%{box-shadow:0 4px 12px rgba(220,38,38,.35)}50%{box-shadow:0 4px 22px rgba(220,38,38,.7)}}
  .rec-dot{width:9px;height:9px;background:#FCA5A5;border-radius:50%}
  .btn-rec-start.grabando .rec-dot{background:white;animation:blink .8s ease-in-out infinite}
  @keyframes blink{0%,100%{opacity:1}50%{opacity:.2}}
  .rec-timer{font-size:13px;font-weight:700;color:#DC2626;font-variant-numeric:tabular-nums;
    background:#FEF2F2;border:1px solid #FECACA;padding:5px 12px;border-radius:8px;letter-spacing:.5px}
  .rec-timer.pausado{color:#D97706;background:#FFFBEB;border-color:#FDE68A}
  .rec-timer.hidden{display:none}
  .rec-status{font-size:12px;color:var(--gray);font-style:italic;width:100%;margin-top:2px}
  .rec-segmentos{font-size:12px;color:#6B7280;background:#F3F4F6;border-radius:8px;
    padding:6px 12px;margin-top:6px;display:none}
  .rec-segmentos.show{display:block}
  .whisper-loading{display:none;align-items:center;gap:10px;background:#FEF2F2;
    border:1px solid #FECACA;border-radius:10px;padding:12px 16px;margin-top:10px;
    font-size:13px;color:#991B1B}
  .whisper-loading.show{display:flex}
  .whisper-spinner{width:18px;height:18px;border:2px solid #FECACA;border-top-color:#DC2626;
    border-radius:50%;animation:spin .8s linear infinite}


  /* PREVIEW */
  #acta-preview-overlay{display:none;position:fixed;inset:0;background:rgba(10,16,40,.7);
    z-index:1000;overflow-y:auto;padding:40px 20px;backdrop-filter:blur(4px);animation:fadeIn .2s ease}
  .acta-preview-container{max-width:780px;margin:0 auto;background:white;
    border-radius:16px;overflow:hidden;box-shadow:0 24px 80px rgba(0,0,0,.4)}
  .preview-toolbar{background:var(--navy);padding:16px 24px;display:flex;align-items:center;justify-content:space-between}
  .preview-toolbar span{color:var(--accent-light);font-size:14px;font-weight:600;font-family:'Playfair Display',serif}
  .preview-toolbar .actions{display:flex;gap:10px}

  /* ACTA DOC */
  #acta-doc{padding:48px 56px;font-family:Arial,sans-serif;color:#111;font-size:11pt;line-height:1.5;background:white}
  .acta-main-table{width:100%;border-collapse:collapse}
  .acta-main-table td,.acta-main-table th{border:1px solid #444;padding:6px 10px;vertical-align:middle;font-size:10.5pt}
  .acta-logo-cell{width:120px;text-align:center;vertical-align:middle;padding:10px}
  .logo-placeholder{width:90px;height:55px;border:1px dashed #aaa;display:inline-flex;
    align-items:center;justify-content:center;font-size:9px;color:#aaa;text-align:center;border-radius:4px}
  .acta-num-cell{text-align:center;font-weight:bold;font-size:14pt;vertical-align:middle;letter-spacing:1px}
  .field-label-doc{font-weight:bold;white-space:nowrap;width:130px;background:#f0f0f0}
  .asistentes-header-doc{font-weight:bold;background:#f0f0f0;text-align:center}
  .section-hdr{background:#1A2E6E;color:white;font-weight:bold;font-size:11pt;text-align:center;padding:8px 10px;letter-spacing:.5px}
  .content-cell{min-height:80px;vertical-align:top;padding:10px;font-size:10.5pt;color:#222;white-space:pre-wrap}
  .comp-hdr{background:#1A2E6E;color:white;font-weight:bold;text-align:center;font-size:10pt;padding:7px 8px}
  .proxima-lbl{font-weight:bold;background:#f0f0f0;padding:7px 10px;font-size:10pt}
  .firma-cell{text-align:center;vertical-align:bottom;padding:12px 16px;height:80px}
  .firma-line-doc{border-top:1px solid #333;margin:0 20px 4px}
  .firma-nombre{font-weight:bold;font-size:10pt;margin-top:2px}
  .firma-rol{font-size:9pt;color:#555}

  .btn-send {
    background: linear-gradient(135deg, #0ea5e9, #0369a1);
    color: white;
    box-shadow: 0 4px 12px rgba(14,165,233,.35);
  }
  .btn-send:hover { background: linear-gradient(135deg, #38bdf8, #0284c7); transform: translateY(-1px); }
  .btn-send:disabled { opacity: .6; cursor: not-allowed; transform: none; }

  /* Toast */
  #toast {
    position: fixed; bottom: 28px; left: 50%; transform: translateX(-50%) translateY(80px);
    background: #1A2E6E; color: white; padding: 14px 24px; border-radius: 12px;
    font-size: 14px; font-weight: 600; box-shadow: 0 8px 32px rgba(0,0,0,.25);
    z-index: 9999; transition: transform .35s cubic-bezier(.34,1.56,.64,1);
    display: flex; align-items: center; gap: 10px; white-space: nowrap;
  }
  #toast.show { transform: translateX(-50%) translateY(0); }
  #toast.error { background: #7f1d1d; }
  #toast.success { background: #14532d; }
  #toast.info { background: #92400E; }
  @media print{
    body *{visibility:hidden}
    #acta-doc,#acta-doc *{visibility:visible}
    #acta-doc{position:fixed;top:0;left:0;width:100%;padding:28px 48px;font-size:10pt}
    .preview-toolbar{display:none!important}
  }

  /* UTILS */
  @keyframes fadeUp{from{opacity:0;transform:translateY(24px)}to{opacity:1;transform:translateY(0)}}
  @keyframes fadeIn{from{opacity:0}to{opacity:1}}
  .hidden{display:none!important}
  .badge{display:inline-block;background:var(--blue);color:white;font-size:11px;font-weight:700;padding:2px 8px;border-radius:10px;margin-left:6px}

  @media(max-width:640px){
    .form-grid,.form-grid.three{grid-template-columns:1fr}
    .span-2{grid-column:span 1}
    .docentes-grid{grid-template-columns:1fr}
    #acta-doc{padding:32px 24px}
    .topbar{padding:0 16px}
    .tabs{padding:0 16px}
    .main-content{padding:24px 16px}
    .card{padding:20px}
  }
</style>
</head>
<body>

<!-- LOGIN -->
<div id="login-screen">
  <div class="login-card">
    <div class="login-logo">
      <div class="icon">üìã</div>
      <h1>Sistema de Actas</h1>
      <p>Acceso restringido al equipo de trabajo</p>
    </div>
    <div id="error-msg" class="error-msg">Usuario o contrase√±a incorrectos</div>
    <div class="form-group">
      <label>Usuario</label>
      <input type="text" id="login-user" placeholder="Ingresa tu usuario" autocomplete="username">
    </div>
    <div class="form-group">
      <label>Contrase√±a</label>
      <input type="password" id="login-pass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password">
    </div>
    <button class="btn btn-primary" onclick="doLogin()">Ingresar ‚Üí</button>
  </div>
</div>

<!-- APP -->
<div id="app">
  <div class="topbar">
    <div class="topbar-brand">
      <div class="icon">üìã</div>
      <h2>Sistema de Actas</h2>
    </div>
    <div class="topbar-right">
      <div class="user-badge">üë§ <span id="current-user-label">‚Äî</span></div>
      <button class="btn btn-secondary btn-sm" onclick="doLogout()">Salir</button>
    </div>
  </div>
  <div class="tabs">
    <button class="tab-btn active" onclick="switchTab('nueva')" id="tab-nueva">‚úèÔ∏è Nueva Acta</button>
  </div>

  <!-- NUEVA ACTA -->
  <div id="panel-nueva" class="main-content">
    <div class="section-header">
      <div>
        <h2>Nueva Acta de Reuni√≥n</h2>
        <p>Completa los campos para generar el acta formal</p>
      </div>
    </div>
    <div class="app-form">

      <!-- 1. DATOS GENERALES -->
      <div class="card">
        <div class="card-title"><span class="dot"></span>Datos Generales de la Reuni√≥n</div>
        <div class="form-grid">
          <!-- Ajuste 1: n√∫mero manual -->
          <div class="form-group">
            <label>N√∫mero del Acta *</label>
            <input type="text" id="f-numero" placeholder="Ej: 001">
          </div>
          <div class="form-group">
            <label>Fecha de la reuni√≥n *</label>
            <input type="date" id="f-fecha">
          </div>
          <div class="form-group">
            <label>Hora de inicio</label>
            <input type="time" id="f-hora-inicio">
          </div>
          <div class="form-group">
            <label>Hora de finalizaci√≥n</label>
            <input type="time" id="f-hora-fin">
          </div>
          <!-- Ajuste 2: lugar como texto libre -->
          <div class="form-group span-2">
            <label>Lugar / Modalidad *</label>
            <input type="text" id="f-modalidad" placeholder="Ej: Sala de reuniones ‚Äî Presencial, Google Meet ‚Äî Virtual...">
          </div>
          <!-- Ajuste 3: unidad fija -->
          <div class="form-group">
            <label>Unidad / Dependencia</label>
            <input type="text" id="f-unidad" value="Educaci√≥n" class="field-readonly" readonly>
          </div>
          <!-- Ajuste 4: responsable fijo -->
          <div class="form-group">
            <label>Responsable</label>
            <input type="text" id="f-lider" value="Carlos Arturo Castro Rojas" class="field-readonly" readonly>
          </div>
          <div class="form-group span-2">
            <label>Elaborado por ‚Äî Relator *</label>
            <input type="text" id="f-elabora" placeholder="Nombre de quien redacta el acta">
          </div>
        </div>
      </div>

      <!-- 2. ASISTENTES ‚Äî Ajuste 5 -->
      <div class="card">
        <div class="card-title"><span class="dot"></span>Asistentes</div>
        <p style="font-size:13px;color:var(--gray);margin-bottom:16px;">Selecciona los docentes que asistieron a la reuni√≥n</p>
        <div class="docentes-grid" id="docentes-grid"></div>
      </div>

      <!-- 3. OBJETIVOS ‚Äî Ajuste 7 -->
      <div class="card">
        <div class="card-title"><span class="dot"></span>Objetivos de la Reuni√≥n</div>
        <p style="font-size:13px;color:var(--gray);margin-bottom:14px;">Escribe las ideas de los objetivos de forma libre. La IA los redactar√° de manera formal.</p>
        <div class="form-group">
          <label>Ideas de los objetivos</label>
          <textarea id="f-objetivos" placeholder="Ej: revisar los resultados del periodo, hablar del plan de mejora, definir fechas de entrega..." style="min-height:85px;"></textarea>
        </div>
        <button class="btn btn-ai btn-sm" onclick="mejorarTexto('obj')">‚ú® Redactar con IA</button>
        <div class="ai-loading" id="ai-loading-obj"><div class="ai-spinner"></div> Redactando objetivos formales...</div>
        <div class="ai-result" id="ai-result-obj"></div>
        <div class="ai-result-actions" id="ai-actions-obj" style="display:none">
          <button class="btn btn-success btn-sm" onclick="usarIA('obj')">‚úî Usar este texto</button>
          <button class="btn btn-danger btn-sm" onclick="descartarIA('obj')">‚úï Descartar</button>
        </div>
      </div>

      <!-- 4. DESARROLLO ‚Äî 3 paneles -->
      <div class="card">
        <div class="card-title"><span class="dot"></span>Desarrollo de los Temas Tratados</div>
        <p style="font-size:13px;color:var(--gray);margin-bottom:18px;">Usa las notas escritas, la grabaci√≥n de voz, o ambas. Luego unifica todo con IA en el panel final.</p>

        <!-- FILA SUPERIOR: Notas (izq) + Grabaci√≥n (der) -->
        <div class="dev-grid">

          <!-- PANEL IZQUIERDO: Notas escritas -->
          <div class="dev-panel dev-panel-notas">
            <div class="dev-panel-title">üìù Notas Escritas</div>
            <p class="dev-panel-desc">Escribe libremente los puntos tratados en la reuni√≥n.</p>
            <div class="form-group" style="margin-bottom:10px">
              <textarea id="f-notas" placeholder="Ej: se habl√≥ de los resultados del periodo, hay 3 estudiantes en riesgo, los docentes propusieron tutor√≠as los viernes..." style="min-height:160px;"></textarea>
            </div>
            <button class="btn btn-ai btn-sm" onclick="redactarNotas()">‚ú® Redactar notas con IA</button>
            <div class="ai-loading" id="ai-loading-notas"><div class="ai-spinner"></div> Redactando notas formales...</div>
            <div class="ai-result" id="ai-result-notas"></div>
            <div class="ai-result-actions" id="ai-actions-notas" style="display:none">
              <button class="btn btn-success btn-sm" onclick="usarIANotas()">‚úî Usar este texto</button>
              <button class="btn btn-danger btn-sm" onclick="descartarIANotas()">‚úï Descartar</button>
            </div>
            <!-- Recuadro texto aprobado notas -->
            <div id="panel-notas-aprobado" style="display:none;margin-top:12px">
              <div class="texto-aprobado-header">‚úÖ Texto aprobado ‚Äî Notas</div>
              <div id="notas-aprobadas-box" class="texto-aprobado-box"></div>
            </div>
          </div>

          <!-- PANEL DERECHO: Grabaci√≥n de voz -->
          <div class="dev-panel dev-panel-rec">
            <div class="dev-panel-title">üéôÔ∏è Grabaci√≥n de Voz</div>
            <p class="dev-panel-desc">Graba la reuni√≥n. Cada 20 min se guarda un segmento autom√°ticamente.</p>

            <div class="rec-bar" style="margin-bottom:10px">
              <button class="btn-rec btn-rec-start" id="btn-grabar" onclick="recAccion('grabar')">
                <span class="rec-dot"></span>
                <span id="rec-label">Iniciar grabaci√≥n</span>
              </button>
              <button class="btn-rec btn-rec-pause" id="btn-pausar" onclick="recAccion('pausar')" disabled style="display:none">
                ‚è∏Ô∏è <span id="pause-label">Pausar</span>
              </button>
              <button class="btn-rec btn-rec-stop" id="btn-finalizar" onclick="recAccion('finalizar')" disabled style="display:none">
                ‚èπÔ∏è Finalizar
              </button>
              <div class="rec-timer hidden" id="rec-timer">00:00</div>
            </div>
            <div class="rec-status" id="rec-status">Presiona "Iniciar grabaci√≥n" para comenzar</div>

            <!-- Transcripci√≥n acumulada colapsable -->
            <div id="transcripcion-acumulada-wrap" style="display:none;margin-top:10px">
              <button class="btn btn-secondary btn-sm" onclick="toggleTranscripcion()" id="btn-ver-trans" style="font-size:12px;padding:6px 12px">
                üëÅ Ver transcripci√≥n acumulada
              </button>
              <div id="transcripcion-acumulada-box" style="display:none;margin-top:8px;background:#F8FAFF;border:1px solid #D0D5E8;border-radius:10px;padding:12px;font-size:12.5px;color:#374151;line-height:1.6;max-height:180px;overflow-y:auto;white-space:pre-wrap"></div>
            </div>

            <div class="whisper-loading" id="whisper-loading" style="margin-top:10px">
              <div class="whisper-spinner"></div>
              <span id="whisper-status-text">Transcribiendo audio con Groq Whisper...</span>
            </div>

            <!-- Contador de segmentos transcritos -->
            <div id="contador-segmentos" style="display:none;margin-top:10px">
              <div class="segmentos-contador-box" id="segmentos-contador-box"></div>
            </div>

            <div class="rec-segmentos" id="rec-segmentos" style="margin-top:8px"></div>

            <button class="btn btn-ai btn-sm" id="btn-redactar-grabacion" onclick="redactarGrabacion()" style="margin-top:10px;display:none">‚ú® Redactar grabaci√≥n con IA</button>
            <div class="ai-loading" id="ai-loading-grabacion"><div class="ai-spinner"></div> Redactando grabaci√≥n formal...</div>
            <div class="ai-result" id="ai-result-grabacion"></div>
            <div class="ai-result-actions" id="ai-actions-grabacion" style="display:none">
              <button class="btn btn-success btn-sm" onclick="usarIAGrabacion()">‚úî Usar este texto</button>
              <button class="btn btn-danger btn-sm" onclick="descartarIAGrabacion()">‚úï Descartar</button>
            </div>
            <!-- Recuadro texto aprobado grabaci√≥n -->
            <div id="panel-grabacion-aprobado" style="display:none;margin-top:12px">
              <div class="texto-aprobado-header">‚úÖ Texto aprobado ‚Äî Grabaci√≥n</div>
              <div id="grabacion-aprobada-box" class="texto-aprobado-box"></div>
            </div>
          </div>
        </div>

        <!-- PANEL INFERIOR: Desarrollo final unificado -->
        <div class="dev-panel dev-panel-final" style="margin-top:16px">
          <div class="dev-panel-title">ü§ñ Desarrollo Final del Acta</div>
          <p class="dev-panel-desc">Este es el texto que ir√° al acta oficial. Puedes escribirlo directamente, o dejar que la IA unifique las notas y la grabaci√≥n.</p>
          <div class="form-group" style="margin-bottom:10px">
            <textarea id="f-desarrollo" placeholder="El texto final del desarrollo aparecer√° aqu√≠, o escr√≠belo directamente..." style="min-height:140px;"></textarea>
          </div>
          <button class="btn btn-unificar btn-sm" onclick="unificarConIA()">ü§ñ Unificar notas + grabaci√≥n con IA</button>
          <div class="ai-loading" id="ai-loading-unificar"><div class="ai-spinner"></div> Unificando y redactando desarrollo final...</div>
          <div class="ai-result" id="ai-result-unificar"></div>
          <div class="ai-result-actions" id="ai-actions-unificar" style="display:none">
            <button class="btn btn-success btn-sm" onclick="usarIAUnificar()">‚úî Usar como desarrollo final</button>
            <button class="btn btn-danger btn-sm" onclick="descartarIAUnificar()">‚úï Descartar</button>
          </div>
        </div>
      </div>

      <!-- 5. COMPROMISOS ‚Äî Ajuste 8 -->
      <div class="card">
        <div class="card-title"><span class="dot"></span>Compromisos</div>
        <div id="compromisos-list"><p style="font-size:13px;color:var(--gray);margin-bottom:14px;">No hay compromisos registrados a√∫n.</p></div>
        <button class="btn btn-blue btn-sm" onclick="addCompromiso()">+ Agregar compromiso</button>
      </div>

      <!-- 6. CIERRE -->
      <div class="card">
        <div class="card-title"><span class="dot"></span>Cierre</div>
        <div class="form-group">
          <label>Fecha, hora y modalidad de la pr√≥xima reuni√≥n</label>
          <textarea id="f-observaciones" placeholder="Ej: Viernes 7 de marzo de 2026, 9:00 AM, modalidad presencial..." style="min-height:65px;"></textarea>
        </div>
      </div>

      <div style="display:flex;gap:12px;justify-content:flex-end;margin-bottom:40px;">
        <button class="btn btn-sm" style="background:var(--gray-light);color:var(--text);border:none;font-family:'DM Sans',sans-serif;font-weight:600;cursor:pointer;" onclick="limpiarForm()">Limpiar</button>
        <button class="btn btn-send btn-sm" id="btn-enviar-form" onclick="enviarCorreo('form')">üìß Enviar y Descargar Word</button>
        <button class="btn btn-primary" style="width:auto;" onclick="generarActa()">üìÑ Generar Acta Formal</button>
      </div>
    </div>
  </div>

  <!-- HISTORIAL -->
</div>

<!-- PREVIEW -->
<div id="acta-preview-overlay">
  <div class="acta-preview-container">
    <div class="preview-toolbar">
      <span>Vista previa del Acta</span>
      <div class="actions">
        <button class="btn btn-success btn-sm" onclick="imprimirActa()">üñ®Ô∏è Guardar / Imprimir PDF</button>
        <button class="btn btn-send btn-sm" id="btn-enviar-preview" onclick="enviarCorreo('preview')">üìß Enviar y Descargar Word</button>
        <button class="btn btn-secondary btn-sm" onclick="cerrarPreview()">‚úï Cerrar</button>
      </div>
    </div>
    <div id="acta-doc"></div>
  </div>
</div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê GROQ API (gratuito, sin tarjeta) ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚Üí Obt√©n tu clave en: https://console.groq.com ‚Üí API Keys
const GROQ_API_KEY = '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';
// ‚Üí Reemplaza estos 3 valores con los tuyos de emailjs.com
const EMAILJS_SERVICE_ID  = 'service_fvgalqp';
const EMAILJS_TEMPLATE_ID = 'template_pj18hkk';
const EMAILJS_PUBLIC_KEY  = 'bTZ5nTxjE2eDFwaQC';
const CORREO_DESTINO      = 'carcastro@colegio.cafam.edu.co';

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê USUARIOS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const USUARIOS = [
  { user:'coordinador', pass:'edu2024',   nombre:'Carlos Arturo Castro Rojas' },
  { user:'docente1',    pass:'clase2024', nombre:'Docente 1' },
  { user:'docente2',    pass:'aula2024',  nombre:'Docente 2' },
];

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê DOCENTES (Ajuste 5) ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const DOCENTES = [
  'Claudia Raquel Rodr√≠guez Salinas',
  'Oscar M√©ndez Rojas',
  'Katerine Julieth Gil Cubillos',
  'Viviana Marcela Botache',
  'Javier Arturo Hern√°ndez Rosas',
  'Andres Felipe Alfonso',
  'Leidy Jeniffer Aperador Umba',
  'Franklyn Alejandro Dur√°n',
];

// Opciones para responsables de compromisos (Ajuste 8)
const RESP_COMPROMISOS = [
  'Coordinador del √Årea',
  'Docentes del √Årea',
  ...DOCENTES
];

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê AUTH ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let sesionActiva = null;

function doLogin() {
  const u = document.getElementById('login-user').value.trim();
  const p = document.getElementById('login-pass').value.trim();
  const found = USUARIOS.find(x => x.user === u && x.pass === p);
  if (found) {
    sesionActiva = found;
    document.getElementById('login-screen').style.display = 'none';
    document.getElementById('app').style.display = 'block';
    document.getElementById('current-user-label').textContent = found.nombre;
    renderDocentesGrid();
  } else {
    document.getElementById('error-msg').style.display = 'block';
  }
}

function doLogout() {
  sesionActiva = null;
  document.getElementById('login-screen').style.display = 'flex';
  document.getElementById('app').style.display = 'none';
  document.getElementById('login-user').value = '';
  document.getElementById('login-pass').value = '';
  document.getElementById('error-msg').style.display = 'none';
}

document.addEventListener('keydown', e => {
  if (e.key === 'Enter' && document.getElementById('login-screen').style.display !== 'none') doLogin();
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TABS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê ASISTENTES ‚Äî checkboxes (Ajuste 5) ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let asistentesSeleccionados = new Set();

function renderDocentesGrid() {
  const grid = document.getElementById('docentes-grid');
  grid.innerHTML = DOCENTES.map(nombre => {
    const sel = asistentesSeleccionados.has(nombre);
    return `<label class="docente-check ${sel?'selected':''}" id="chk-${btoa(encodeURIComponent(nombre))}">
      <input type="checkbox" ${sel?'checked':''} onchange="toggleDocente('${nombre}',this)">
      <span>${nombre}</span>
    </label>`;
  }).join('');
}

function toggleDocente(nombre, cb) {
  const lbl = cb.closest('.docente-check');
  if (cb.checked) { asistentesSeleccionados.add(nombre); lbl.classList.add('selected'); }
  else            { asistentesSeleccionados.delete(nombre); lbl.classList.remove('selected'); }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê COMPROMISOS (Ajuste 8) ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let compromisos = [];

function addCompromiso() {
  compromisos.push({ id: Date.now(), responsable:'', descripcion:'', fechaInicio:'', fechaFin:'' });
  renderCompromisos();
}

function removeCompromiso(id) {
  compromisos = compromisos.filter(c => c.id !== id);
  renderCompromisos();
}

function renderCompromisos() {
  const c = document.getElementById('compromisos-list');
  if (!compromisos.length) {
    c.innerHTML = '<p style="font-size:13px;color:var(--gray);margin-bottom:14px;">No hay compromisos registrados a√∫n.</p>';
    return;
  }
  c.innerHTML = compromisos.map((comp, i) => `
    <div class="compromiso-card">
      <div class="compromiso-header">
        <span class="compromiso-num">Compromiso ${i+1}</span>
        <button class="remove-btn" onclick="removeCompromiso(${comp.id})">‚úï</button>
      </div>
      <div class="form-grid app-form">
        <div class="form-group span-2">
          <label>Responsable</label>
          <select onchange="compromisos.find(x=>x.id===${comp.id}).responsable=this.value">
            <option value="">Seleccionar responsable...</option>
            ${RESP_COMPROMISOS.map(r=>`<option value="${r}" ${comp.responsable===r?'selected':''}>${r}</option>`).join('')}
          </select>
        </div>
        <div class="form-group span-2">
          <label>Descripci√≥n del compromiso *</label>
          <textarea placeholder="Describe el compromiso o tarea acordada..."
            onchange="compromisos.find(x=>x.id===${comp.id}).descripcion=this.value">${comp.descripcion}</textarea>
        </div>
        <div class="form-group">
          <label>Fecha de inicio</label>
          <input type="date" value="${comp.fechaInicio}"
            onchange="compromisos.find(x=>x.id===${comp.id}).fechaInicio=this.value">
        </div>
        <div class="form-group">
          <label>Fecha de finalizaci√≥n</label>
          <input type="date" value="${comp.fechaFin}"
            onchange="compromisos.find(x=>x.id===${comp.id}).fechaFin=this.value">
        </div>
      </div>
    </div>`).join('');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê IA ‚Äî Mejora de textos (Ajustes 6 y 7) ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TEXTOS IA Y PROMPTS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const textoIA = { obj:'', notas:'', grabacion:'', unificado:'' };
let transcripcionAcumulada = ''; // texto crudo de todos los segmentos grabados
let notasRedactadas   = '';      // resultado IA del panel de notas
let grabacionRedactada = '';     // resultado IA del panel de grabaci√≥n

const PROMPT_DEV = ideas => `Eres un redactor de actas institucionales. Tu trabajo es tomar las notas de una reuni√≥n y redactarlas de forma formal, sin agregar absolutamente nada que no est√© en las notas.

REGLA ABSOLUTA: Solo puedes usar la informaci√≥n que aparece en las notas. No agregues datos, nombres, cifras, fechas, acuerdos ni contexto que no est√©n escritos en las notas. Si inventas algo, el resultado es inv√°lido.

FORMATO DE SALIDA:
Cada tema es un punto numerado. Sigue esta estructura exacta:

[n√∫mero]. [T√≠tulo breve del tema].
[Desarrollo en prosa formal, tercera persona, sin vi√±etas ni guiones.]

Deja una l√≠nea en blanco entre cada punto.

Al final, un p√°rrafo que inicie con "En s√≠ntesis," resumiendo solo lo que aparece en los puntos anteriores.

ESTILO: Tercera persona siempre. Formal e institucional. Corrige ortograf√≠a de las notas pero no cambies el significado.

NOTAS DE LA REUNI√ìN:
${ideas}

Responde √∫nicamente con los puntos numerados y la s√≠ntesis. Sin texto adicional antes o despu√©s.`;

const PROMPTS = {
  obj: ideas => `Eres un experto en redacci√≥n de actas institucionales formales en espa√±ol colombiano.

A partir de estas ideas, redacta los OBJETIVOS DE LA REUNI√ìN aplicando las siguientes reglas sin excepci√≥n:

REGLAS OBLIGATORIAS:
1. ORTOGRAF√çA: Corrige todos los errores ortogr√°ficos y de puntuaci√≥n.
2. ESTILO: Tono estrictamente formal e institucional. Tercera persona del singular. Sin lenguaje coloquial ni expresiones informales.
3. REDACCI√ìN: Cada objetivo inicia con verbo en infinitivo (Revisar, Socializar, Establecer, Definir, Evaluar, Analizar, Fortalecer, Identificar...). M√°ximo 2 l√≠neas por objetivo. Lista numerada.
4. SIN REDUNDANCIAS: Elimina repeticiones de ideas, palabras o frases. Si dos ideas son similares, f√∫ndelas en un solo objetivo.
5. SOLO OBJETIVOS: No agregues p√°rrafos de s√≠ntesis, conclusiones ni comentarios adicionales. La respuesta debe contener √∫nicamente la lista de objetivos numerados.

IDEAS:
${ideas}

Responde SOLO con la lista de objetivos numerados. Sin p√°rrafos adicionales, sin s√≠ntesis, sin t√≠tulos.`,

  dev: ideas => PROMPT_DEV(ideas)
};

// ‚îÄ‚îÄ Llamada gen√©rica a Groq llama-3.3 ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function llamarGroq(prompt, maxTokens) {
  maxTokens = maxTokens || 1800;
  const res = await fetch('https://api.groq.com/openai/v1/chat/completions', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${GROQ_API_KEY}` },
    body: JSON.stringify({
      model: 'llama-3.3-70b-versatile',
      messages: [{ role: 'user', content: prompt }],
      temperature: 0.35,
      max_tokens: maxTokens
    })
  });
  const data = await res.json();
  if (data.error) throw new Error(data.error.message);
  return data.choices?.[0]?.message?.content || '';
}

// ‚îÄ‚îÄ Objetivos ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function mejorarTexto(tipo) {
  const ideas = document.getElementById('f-objetivos').value.trim();
  if (!ideas) { alert('Escribe primero las ideas en el campo.'); return; }
  const loading = document.getElementById('ai-loading-obj');
  const result  = document.getElementById('ai-result-obj');
  const actions = document.getElementById('ai-actions-obj');
  loading.classList.add('show');
  result.classList.remove('show');
  actions.style.display = 'none';
  try {
    const texto = await llamarGroq(PROMPTS.obj(ideas), 1500);
    textoIA['obj'] = texto;
    result.textContent = texto;
    result.classList.add('show');
    actions.style.display = 'flex';
  } catch(e) {
    result.textContent = 'Error: ' + e.message;
    result.classList.add('show');
  }
  loading.classList.remove('show');
}
function usarIA(tipo) {
  document.getElementById('f-objetivos').value = textoIA['obj'];
  descartarIA(tipo);
}
function descartarIA(tipo) {
  document.getElementById('ai-result-obj').classList.remove('show');
  document.getElementById('ai-actions-obj').style.display = 'none';
}

// ‚îÄ‚îÄ Panel Notas: Redactar con IA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function redactarNotas() {
  const ideas = document.getElementById('f-notas').value.trim();
  if (!ideas) { alert('Escribe primero las notas en el panel izquierdo.'); return; }
  const loading = document.getElementById('ai-loading-notas');
  const result  = document.getElementById('ai-result-notas');
  const actions = document.getElementById('ai-actions-notas');
  loading.classList.add('show');
  result.classList.remove('show');
  actions.style.display = 'none';
  try {
    const texto = await llamarGroq(PROMPT_DEV(ideas), 1800);
    textoIA['notas'] = texto;
    notasRedactadas = texto;
    result.textContent = texto;
    result.classList.add('show');
    actions.style.display = 'flex';
  } catch(e) {
    result.textContent = 'Error: ' + e.message;
    result.classList.add('show');
  }
  loading.classList.remove('show');
}
function usarIANotas() {
  notasRedactadas = textoIA['notas'];
  descartarIANotas();
  // Mostrar recuadro de texto aprobado en el panel de notas
  let box = document.getElementById('notas-aprobadas-box');
  if (!box) {
    box = document.createElement('div');
    box.id = 'notas-aprobadas-box';
    box.className = 'texto-aprobado-box';
    document.getElementById('panel-notas-aprobado').appendChild(box);
  }
  box.textContent = notasRedactadas;
  document.getElementById('panel-notas-aprobado').style.display = 'block';
  showToast('Notas aprobadas. Puedes unificar abajo.', 'success', 4000);
}
function descartarIANotas() {
  document.getElementById('ai-result-notas').classList.remove('show');
  document.getElementById('ai-actions-notas').style.display = 'none';
}

// ‚îÄ‚îÄ Panel Grabaci√≥n: Redactar transcripci√≥n con IA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function redactarGrabacion() {
  if (!transcripcionAcumulada.trim()) {
    alert('No hay transcripci√≥n acumulada. Graba y finaliza primero.'); return;
  }
  const loading = document.getElementById('ai-loading-grabacion');
  const result  = document.getElementById('ai-result-grabacion');
  const actions = document.getElementById('ai-actions-grabacion');
  loading.classList.add('show');
  result.classList.remove('show');
  actions.style.display = 'none';
  try {
    const texto = await llamarGroq(PROMPT_DEV(transcripcionAcumulada), 1800);
    textoIA['grabacion'] = texto;
    grabacionRedactada = texto;
    result.textContent = texto;
    result.classList.add('show');
    actions.style.display = 'flex';
  } catch(e) {
    result.textContent = 'Error: ' + e.message;
    result.classList.add('show');
  }
  loading.classList.remove('show');
}
function usarIAGrabacion() {
  grabacionRedactada = textoIA['grabacion'];
  descartarIAGrabacion();
  // Mostrar recuadro de texto aprobado en el panel de grabaci√≥n
  let box = document.getElementById('grabacion-aprobada-box');
  if (!box) {
    box = document.createElement('div');
    box.id = 'grabacion-aprobada-box';
    box.className = 'texto-aprobado-box';
    document.getElementById('panel-grabacion-aprobado').appendChild(box);
  }
  box.textContent = grabacionRedactada;
  document.getElementById('panel-grabacion-aprobado').style.display = 'block';
  showToast('Grabacion aprobada. Puedes unificar abajo.', 'success', 4000);
}
function descartarIAGrabacion() {
  document.getElementById('ai-result-grabacion').classList.remove('show');
  document.getElementById('ai-actions-grabacion').style.display = 'none';
}

// ‚îÄ‚îÄ Panel Inferior: Unificar con IA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function unificarConIA() {
  const notasRaw   = document.getElementById('f-notas').value.trim();
  const notasFinal = notasRedactadas || notasRaw;
  const grabFinal  = grabacionRedactada || transcripcionAcumulada;

  if (!notasFinal && !grabFinal) {
    alert('No hay contenido en ning√∫n panel para unificar.'); return;
  }

  const partes = [];
  if (notasFinal) partes.push('=== NOTAS ESCRITAS ===\n' + notasFinal);
  if (grabFinal)  partes.push('=== TRANSCRIPCION DE GRABACION ===\n' + grabFinal);
  const combinado = partes.join('\n\n');

  const promptUnificar = `Eres un redactor experto en actas institucionales formales en espanol colombiano.

Se te entrega informacion proveniente de dos fuentes distintas de una misma reunion: notas escritas y/o transcripcion de grabacion de audio. Ambas fuentes describen la MISMA reunion.

TU TAREA:
1. Lee ambas fuentes con atencion.
2. Elimina toda informacion duplicada o repetida entre ellas.
3. Complementa: si una fuente tiene detalles que la otra no tiene, incluyelos.
4. Redacta un unico texto formal y cohesionado que represente fielmente el desarrollo de la reunion.

REGLAS OBLIGATORIAS:
- SOLO usa informacion que aparezca en alguna de las dos fuentes. No inventes nada.
- Tercera persona siempre. Tono formal e institucional.
- Formato de salida: puntos numerados, cada uno con titulo en su propia linea y desarrollo en prosa debajo.
- Al final, un parrafo que inicie con "En sintesis," resumiendo los puntos principales.
- Sin titulos como NOTAS o GRABACION en el resultado final.

FUENTES:
` + combinado + `

Responde UNICAMENTE con los puntos numerados y la sintesis. Sin texto adicional.`;

  const loading = document.getElementById('ai-loading-unificar');
  const result  = document.getElementById('ai-result-unificar');
  const actions = document.getElementById('ai-actions-unificar');
  loading.classList.add('show');
  result.classList.remove('show');
  actions.style.display = 'none';
  try {
    const texto = await llamarGroq(promptUnificar, 2200);
    textoIA['unificado'] = texto;
    result.textContent = texto;
    result.classList.add('show');
    actions.style.display = 'flex';
  } catch(e) {
    result.textContent = 'Error: ' + e.message;
    result.classList.add('show');
  }
  loading.classList.remove('show');
}
function usarIAUnificar() {
  document.getElementById('f-desarrollo').value = textoIA['unificado'];
  descartarIAUnificar();
  showToast('Desarrollo final actualizado con el texto unificado.', 'success', 4000);
}
function descartarIAUnificar() {
  document.getElementById('ai-result-unificar').classList.remove('show');
  document.getElementById('ai-actions-unificar').style.display = 'none';
}

// ‚îÄ‚îÄ Transcripcion colapsable ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function toggleTranscripcion() {
  const box = document.getElementById('transcripcion-acumulada-box');
  const btn = document.getElementById('btn-ver-trans');
  const visible = box.style.display !== 'none';
  box.style.display = visible ? 'none' : 'block';
  btn.textContent = visible ? 'üëÅ Ver transcripci√≥n acumulada' : 'üôà Ocultar transcripci√≥n';
}

// ‚îÄ‚îÄ Contador visual de segmentos transcritos ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let segmentosTranscritos = []; // array de {num, duracion, palabras}

function actualizarContadorSegmentos() {
  // Registrar el segmento actual
  const num = segmentosTranscritos.length + 1;
  const minutos = Math.floor(recSeconds / 60);
  const palabras = transcripcionAcumulada.trim().split(/\s+/).length;
  segmentosTranscritos.push({ num, minutos, palabras });

  const cont = document.getElementById('contador-segmentos');
  const box  = document.getElementById('segmentos-contador-box');
  cont.style.display = 'block';

  const total = segmentosTranscritos.length;
  const totalPal = segmentosTranscritos.reduce((s, x) => s + x.palabras, 0);

  let html = '<div style="font-weight:700;margin-bottom:8px;font-size:13px;">üì¶ ' + total + ' segmento' + (total!==1?'s':'') + ' transcritos ‚Äî ' + totalPal + ' palabras aprox.</div>';
  html += segmentosTranscritos.map(s =>
    '<div class="seg-item"><span class="seg-badge">SEG ' + s.num + '</span>' +
    '<span>~' + s.minutos + ' min grabados ¬∑ ~' + s.palabras + ' palabras transcritas</span></div>'
  ).join('');
  box.innerHTML = html;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê LIMPIAR ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function limpiarForm() {
  if (!confirm('¬øDeseas limpiar todo el formulario?')) return;
  ['f-numero','f-fecha','f-hora-inicio','f-hora-fin','f-modalidad','f-elabora',
   'f-objetivos','f-notas','f-desarrollo','f-observaciones'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.value = '';
  });
  asistentesSeleccionados = new Set();
  renderDocentesGrid();
  compromisos = [];
  renderCompromisos();
  // Limpiar variables de desarrollo
  transcripcionAcumulada = '';
  notasRedactadas = '';
  grabacionRedactada = '';
  Object.keys(textoIA).forEach(k => textoIA[k] = '');
  // Ocultar paneles IA
  ['obj','notas','grabacion','unificar'].forEach(t => {
    const r = document.getElementById('ai-result-'+t);
    const a = document.getElementById('ai-actions-'+t);
    const l = document.getElementById('ai-loading-'+t);
    if (r) r.classList.remove('show');
    if (a) a.style.display = 'none';
    if (l) l.classList.remove('show');
  });
  // Ocultar transcripcion acumulada y bot√≥n redactar
  const wrap = document.getElementById('transcripcion-acumulada-wrap');
  const box  = document.getElementById('transcripcion-acumulada-box');
  const btnRec = document.getElementById('btn-redactar-grabacion');
  if (wrap) wrap.style.display = 'none';
  if (box)  { box.textContent = ''; box.style.display = 'none'; }
  if (btnRec) btnRec.style.display = 'none';
  // Limpiar recuadros aprobados
  const pna = document.getElementById('panel-notas-aprobado');
  const pga = document.getElementById('panel-grabacion-aprobado');
  const nab = document.getElementById('notas-aprobadas-box');
  const gab = document.getElementById('grabacion-aprobada-box');
  if (pna) pna.style.display = 'none';
  if (pga) pga.style.display = 'none';
  if (nab) nab.textContent = '';
  if (gab) gab.textContent = '';
  // Limpiar contador de segmentos
  segmentosTranscritos = [];
  const cont = document.getElementById('contador-segmentos');
  const cbox = document.getElementById('segmentos-contador-box');
  if (cont) cont.style.display = 'none';
  if (cbox) cbox.innerHTML = '';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê GENERAR ACTA ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function formatFecha(str) {
  if (!str) return '‚Äî';
  const [y,m,d] = str.split('-');
  const meses = ['enero','febrero','marzo','abril','mayo','junio','julio',
                 'agosto','septiembre','octubre','noviembre','diciembre'];
  return `${parseInt(d)} de ${meses[parseInt(m)-1]} de ${y}`;
}

function generarActa() {
  const numero    = document.getElementById('f-numero').value.trim();
  const fecha     = document.getElementById('f-fecha').value;
  const horaIni   = document.getElementById('f-hora-inicio').value;
  const horaFin   = document.getElementById('f-hora-fin').value;
  const modalidad = document.getElementById('f-modalidad').value.trim();
  const elabora   = document.getElementById('f-elabora').value.trim();
  const objetivos = document.getElementById('f-objetivos').value.trim();
  const desarrollo= document.getElementById('f-desarrollo').value.trim();
  const obs       = document.getElementById('f-observaciones').value.trim();
  const lider     = 'Carlos Arturo Castro Rojas';
  const unidad    = 'Educaci√≥n';

  if (!numero || !fecha || !elabora) {
    alert('Campos obligatorios: N√∫mero del Acta, Fecha y Relator.');
    return;
  }

  const fechaElab = new Date().toLocaleDateString('es-CO',{year:'numeric',month:'long',day:'numeric'});
  const asistList = Array.from(asistentesSeleccionados);

  // Filas asistentes
  const asistRows = asistList.length
    ? asistList.map(n=>`<tr>
        <td style="padding:5px 10px;border:1px solid #444">${n}</td>
        <td style="padding:5px 10px;border:1px solid #444">Docente</td>
      </tr>`).join('')
    : `<tr><td colspan="2" style="padding:5px 10px;border:1px solid #444;color:#888;font-style:italic">No se registraron asistentes</td></tr>`;

  // Filas compromisos
  const compRows = compromisos.length
    ? compromisos.map(c=>`<tr>
        <td style="padding:6px 8px;border:1px solid #444">${c.descripcion||'‚Äî'}</td>
        <td style="padding:6px 8px;border:1px solid #444;text-align:center">${c.responsable||'‚Äî'}</td>
        <td style="padding:6px 8px;border:1px solid #444;text-align:center">${formatFecha(c.fechaInicio)}</td>
        <td style="padding:6px 8px;border:1px solid #444;text-align:center">${formatFecha(c.fechaFin)}</td>
      </tr>`).join('')
    : `<tr>
        <td style="padding:10px 8px;border:1px solid #444">&nbsp;</td>
        <td style="padding:10px 8px;border:1px solid #444">&nbsp;</td>
        <td style="padding:10px 8px;border:1px solid #444">&nbsp;</td>
        <td style="padding:10px 8px;border:1px solid #444">&nbsp;</td>
      </tr>`;

  // Firmas asistentes (pares)
  let firmasRows = '';
  for (let i = 0; i < Math.max(2, asistList.length); i += 2) {
    const a1 = asistList[i]   || '';
    const a2 = asistList[i+1] || '';
    firmasRows += `<tr>
      <td class="firma-cell" style="border:1px solid #444" colspan="2">
        <div class="firma-line-doc"></div>
        <div class="firma-nombre">${a1||'Asistente '+(i+1)}</div>
        <div class="firma-rol">Docente</div>
      </td>
      <td class="firma-cell" style="border:1px solid #444" colspan="2">
        <div class="firma-line-doc"></div>
        <div class="firma-nombre">${a2||'Asistente '+(i+2)}</div>
        <div class="firma-rol">Docente</div>
      </td>
    </tr>`;
  }

  const docHTML = `
  <table class="acta-main-table">
    <tr>
      <td class="acta-logo-cell" rowspan="6"><div class="logo-placeholder">LOGO<br>INSTITUCI√ìN</div></td>
      <td class="acta-num-cell" colspan="2">ACTA No. ${numero}</td>
    </tr>
    <tr><td class="field-label-doc">FECHA Y HORA:</td><td>${formatFecha(fecha)}, HORA: ${horaIni||'‚Äî'} ‚Äì ${horaFin||'‚Äî'}</td></tr>
    <tr><td class="field-label-doc">MODALIDAD:</td><td>${modalidad||'‚Äî'}</td></tr>
    <tr><td class="field-label-doc">UNIDAD:</td><td>${unidad}</td></tr>
    <tr><td class="field-label-doc">RESPONSABLE:</td><td>${lider}</td></tr>
    <tr><td class="field-label-doc">RELATOR:</td><td colspan="2">${elabora}</td></tr>

    <tr>
      <td class="field-label-doc">ASISTENTES:</td>
      <td class="asistentes-header-doc">NOMBRES COMPLETOS</td>
      <td class="asistentes-header-doc">CARGO</td>
    </tr>
    ${asistRows}

    <tr><td class="section-hdr" colspan="3">OBJETIVO DE LA REUNI√ìN</td></tr>
    <tr><td class="content-cell" colspan="3">${objetivos||'‚Äî'}</td></tr>

    <tr><td class="section-hdr" colspan="3">DESARROLLO DE LOS TEMAS TRATADOS</td></tr>
    <tr><td class="content-cell" colspan="3" style="min-height:140px">${desarrollo||'‚Äî'}</td></tr>

    <tr><td class="comp-hdr" colspan="4">COMPROMISOS</td></tr>
    <tr>
      <th style="border:1px solid #444;padding:7px 8px;background:#f0f0f0;font-size:10pt">Compromiso</th>
      <th style="border:1px solid #444;padding:7px 8px;background:#f0f0f0;font-size:10pt;text-align:center">Responsable</th>
      <th style="border:1px solid #444;padding:7px 8px;background:#f0f0f0;font-size:10pt;text-align:center">Inicio</th>
      <th style="border:1px solid #444;padding:7px 8px;background:#f0f0f0;font-size:10pt;text-align:center">Fin</th>
    </tr>
    ${compRows}

    <tr><td class="proxima-lbl" colspan="4">FECHA, HORA Y MODALIDAD DE LA PR√ìXIMA REUNI√ìN:</td></tr>
    <tr><td colspan="4" style="padding:8px 10px;border:1px solid #444;min-height:36px">${obs||'&nbsp;'}</td></tr>

    <tr>
      <td class="firma-cell" style="border:1px solid #444" colspan="2">
        <div class="firma-line-doc"></div>
        <div class="firma-nombre">${lider}</div>
        <div class="firma-rol">Firma Responsable</div>
      </td>
      <td class="firma-cell" style="border:1px solid #444" colspan="2">
        <div class="firma-line-doc"></div>
        <div class="firma-nombre">${elabora}</div>
        <div class="firma-rol">Firma Relator</div>
      </td>
    </tr>
    ${firmasRows}
  </table>
  <p style="font-size:9pt;color:#888;text-align:right;margin-top:10px">Elaborada el ${fechaElab} ¬∑ Sistema de Actas ‚Äî Educaci√≥n</p>`;

  // Guardar en localStorage
  const actaData = {
    numero, fecha, horaIni, horaFin, modalidad, lider, unidad,
    asistentes: asistList, compromisos:[...compromisos],
    objetivos, desarrollo, obs, elabora,
    fechaElab, docHTML,
    creadaPor: sesionActiva.nombre,
    timestamp: Date.now()
  };
  const actas = JSON.parse(localStorage.getItem('actas_list')||'[]');
  actas.unshift(actaData);
  localStorage.setItem('actas_list', JSON.stringify(actas));
  mostrarPreview(docHTML);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PREVIEW ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function mostrarPreview(html) {
  document.getElementById('acta-doc').innerHTML = html;
  document.getElementById('acta-preview-overlay').style.display = 'block';
  document.body.style.overflow = 'hidden';
}
function cerrarPreview() {
  document.getElementById('acta-preview-overlay').style.display = 'none';
  document.body.style.overflow = '';
}
function imprimirActa() { window.print(); }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê HISTORIAL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TOAST ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showToast(msg, tipo = 'success', duracion = 4000) {
  let t = document.getElementById('toast');
  if (!t) {
    t = document.createElement('div');
    t.id = 'toast';
    document.body.appendChild(t);
  }
  t.className = tipo;
  t.innerHTML = (tipo === 'success' ? '‚úÖ ' : tipo === 'error' ? '‚ùå ' : '‚è≥ ') + msg;
  t.classList.add('show');
  clearTimeout(t._timer);
  if (duracion > 0) t._timer = setTimeout(() => t.classList.remove('show'), duracion);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê GENERAR WORD (JSZip nativo - Formato Modelo Cafam) ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function cargarJSZip() {
  return new Promise((resolve, reject) => {
    if (window.JSZip) { resolve(); return; }
    const s = document.createElement('script');
    s.src = 'https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js';
    s.onload = resolve; s.onerror = reject;
    document.head.appendChild(s);
  });
}

function escXml(v) {
  return (v||'').toString().replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&apos;');
}

// ‚îÄ‚îÄ helpers XML ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const BRD_TBL = `<w:tblBorders><w:top w:val="single" w:sz="4" w:space="0" w:color="auto"/><w:left w:val="single" w:sz="4" w:space="0" w:color="auto"/><w:bottom w:val="single" w:sz="4" w:space="0" w:color="auto"/><w:right w:val="single" w:sz="4" w:space="0" w:color="auto"/><w:insideH w:val="single" w:sz="4" w:space="0" w:color="auto"/><w:insideV w:val="single" w:sz="4" w:space="0" w:color="auto"/></w:tblBorders>`;
const BRD_TC  = `<w:tcBorders><w:top w:val="single" w:sz="4" w:space="0" w:color="auto"/><w:left w:val="single" w:sz="4" w:space="0" w:color="auto"/><w:bottom w:val="single" w:sz="4" w:space="0" w:color="auto"/><w:right w:val="single" w:sz="4" w:space="0" w:color="auto"/></w:tcBorders>`;

// P√°rrafo azul negrita Arial 22
function pAzul(txt, jc) {
  jc = jc || 'left';
  return `<w:p><w:pPr><w:jc w:val="${jc}"/></w:pPr><w:r><w:rPr><w:rFonts w:ascii="Arial" w:hAnsi="Arial" w:cs="Arial"/><w:b/><w:bCs/><w:color w:val="0000FF"/><w:sz w:val="22"/><w:szCs w:val="22"/></w:rPr><w:t xml:space="preserve">${escXml(txt)}</w:t></w:r></w:p>`;
}

// P√°rrafos normales (split por \n)
function pNormal(txt) {
  return (txt||'').split('\n').map(l =>
    `<w:p><w:r><w:rPr><w:rFonts w:ascii="Arial" w:hAnsi="Arial" w:cs="Arial"/><w:sz w:val="22"/><w:szCs w:val="22"/></w:rPr><w:t xml:space="preserve">${escXml(l)}</w:t></w:r></w:p>`
  ).join('');
}

// P√°rrafo de firma: etiqueta + nombre, centrado, azul sz=18
function pFirma(etiq, nombre) {
  const rpr = `<w:rPr><w:rFonts w:ascii="Arial" w:hAnsi="Arial" w:cs="Arial"/><w:b/><w:bCs/><w:color w:val="0000FF"/><w:sz w:val="18"/><w:szCs w:val="18"/></w:rPr>`;
  return `<w:p><w:pPr><w:jc w:val="center"/></w:pPr><w:r>${rpr}<w:t xml:space="preserve">${escXml(etiq)}</w:t></w:r></w:p>` +
         `<w:p><w:pPr><w:jc w:val="center"/></w:pPr><w:r>${rpr}<w:t xml:space="preserve">${escXml(nombre)}</w:t></w:r></w:p>`;
}

// ‚îÄ‚îÄ TABLA 1: Cabecera (logo + ACTA No. + datos + asistentes) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function tblCabecera(numero, fechaHora, modalidad, responsable, relator, asistList) {
  // Logo drawing (rId11 = imagen)
  const drawing = `<w:drawing><wp:inline distT="0" distB="0" distL="0" distR="0" xmlns:wp="http://schemas.openxmlformats.org/drawingml/2006/wordprocessingDrawing"><wp:extent cx="1173480" cy="612775"/><wp:effectExtent l="0" t="0" r="0" b="0"/><wp:docPr id="1" name="Imagen 1"/><wp:cNvGraphicFramePr><a:graphicFrameLocks xmlns:a="http://schemas.openxmlformats.org/drawingml/2006/main" noChangeAspect="1"/></wp:cNvGraphicFramePr><a:graphic xmlns:a="http://schemas.openxmlformats.org/drawingml/2006/main"><a:graphicData uri="http://schemas.openxmlformats.org/drawingml/2006/picture"><pic:pic xmlns:pic="http://schemas.openxmlformats.org/drawingml/2006/picture"><pic:nvPicPr><pic:cNvPr id="0" name="Picture 1"/><pic:cNvPicPr><a:picLocks noChangeAspect="1" noChangeArrowheads="1"/></pic:cNvPicPr></pic:nvPicPr><pic:blipFill><a:blip r:embed="rId11"/><a:srcRect/><a:stretch><a:fillRect/></a:stretch></pic:blipFill><pic:spPr bwMode="auto"><a:xfrm><a:off x="0" y="0"/><a:ext cx="1173480" cy="612775"/></a:xfrm><a:prstGeom prst="rect"><a:avLst/></a:prstGeom><a:noFill/><a:ln><a:noFill/></a:ln></pic:spPr></pic:pic></a:graphicData></a:graphic></wp:inline></w:drawing>`;

  // Fila 1: Logo | "                         ACTA No. NNN"
  function trLogo() {
    const tcLogo = `<w:tc><w:tcPr><w:tcW w:w="1979" w:type="dxa"/><w:vAlign w:val="center"/></w:tcPr>` +
      `<w:p><w:pPr><w:pStyle w:val="Ttulo1"/><w:jc w:val="left"/></w:pPr><w:r><w:rPr><w:noProof/></w:rPr>${drawing}</w:r></w:p></w:tc>`;
    const tcTitulo = `<w:tc><w:tcPr><w:tcW w:w="8172" w:type="dxa"/><w:gridSpan w:val="2"/><w:vAlign w:val="center"/></w:tcPr>` +
      `<w:p><w:pPr><w:pStyle w:val="Ttulo1"/><w:jc w:val="left"/></w:pPr>` +
      `<w:r><w:rPr><w:rFonts w:ascii="Arial" w:hAnsi="Arial"/></w:rPr><w:t xml:space="preserve">                         ACTA No. ${escXml(numero)}</w:t></w:r></w:p></w:tc>`;
    return `<w:tr><w:trPr><w:cantSplit/><w:trHeight w:val="1082"/><w:jc w:val="center"/></w:trPr>${tcLogo}${tcTitulo}</w:tr>`;
  }

  // Fila de dato: etiqueta azul derecha (col1) | valor (col2+3 span 2)
  function trDato(label, valor, altura) {
    altura = altura || 20;
    const tcLabel = `<w:tc><w:tcPr><w:tcW w:w="1979" w:type="dxa"/><w:vAlign w:val="center"/></w:tcPr>` +
      `<w:p><w:pPr><w:jc w:val="right"/><w:rPr><w:rFonts w:ascii="Arial" w:hAnsi="Arial"/><w:b/><w:bCs/><w:color w:val="0000FF"/><w:sz w:val="22"/><w:szCs w:val="22"/></w:rPr></w:pPr>` +
      `<w:r><w:rPr><w:rFonts w:ascii="Arial" w:hAnsi="Arial"/><w:b/><w:bCs/><w:color w:val="0000FF"/><w:sz w:val="22"/><w:szCs w:val="22"/></w:rPr><w:t xml:space="preserve">${escXml(label)}</w:t></w:r></w:p></w:tc>`;
    const tcVal = `<w:tc><w:tcPr><w:tcW w:w="8172" w:type="dxa"/><w:gridSpan w:val="2"/><w:vAlign w:val="center"/></w:tcPr>` +
      `<w:p><w:r><w:rPr><w:rFonts w:ascii="Arial" w:hAnsi="Arial" w:cs="Arial"/><w:sz w:val="22"/><w:szCs w:val="22"/></w:rPr><w:t xml:space="preserve">${escXml(valor)}</w:t></w:r></w:p></w:tc>`;
    return `<w:tr><w:trPr><w:cantSplit/><w:trHeight w:val="${altura}"/><w:jc w:val="center"/></w:trPr>${tcLabel}${tcVal}</w:tr>`;
  }

  // Fila asistente (col1 etiqueta o vac√≠o | col2 nombre | col3 vac√≠a)
  function trAsist(label, nombre) {
    const tcLabel = `<w:tc><w:tcPr><w:tcW w:w="1979" w:type="dxa"/><w:vAlign w:val="center"/></w:tcPr>` +
      (label
        ? `<w:p><w:pPr><w:jc w:val="right"/></w:pPr><w:r><w:rPr><w:rFonts w:ascii="Arial" w:hAnsi="Arial"/><w:b/><w:bCs/><w:color w:val="0000FF"/><w:sz w:val="22"/><w:szCs w:val="22"/></w:rPr><w:t>${escXml(label)}</w:t></w:r></w:p></w:tc>`
        : `<w:p/></w:tc>`);
    const tcNombre = `<w:tc><w:tcPr><w:tcW w:w="3987" w:type="dxa"/><w:vAlign w:val="center"/></w:tcPr>` +
      `<w:p><w:r><w:rPr><w:rFonts w:ascii="Arial" w:hAnsi="Arial" w:cs="Arial"/><w:sz w:val="22"/><w:szCs w:val="22"/></w:rPr><w:t xml:space="preserve">${escXml(nombre)}</w:t></w:r></w:p></w:tc>`;
    const tcVacia = `<w:tc><w:tcPr><w:tcW w:w="4185" w:type="dxa"/><w:vAlign w:val="center"/></w:tcPr><w:p/></w:tc>`;
    return `<w:tr><w:trPr><w:cantSplit/><w:trHeight w:val="20"/><w:jc w:val="center"/></w:trPr>${tcLabel}${tcNombre}${tcVacia}</w:tr>`;
  }

  // Construir filas de asistentes
  let filasAsist = '';
  if (!asistList.length) {
    // 5 filas vac√≠as (como el modelo plantilla)
    for (let i=0; i<5; i++) filasAsist += trAsist('', '');
  } else {
    filasAsist += trAsist('ASISTENTES:', asistList[0]);
    for (let i=1; i<asistList.length; i++) filasAsist += trAsist('', asistList[i]);
  }
  // Fila final vac√≠a (col1+col3 span 2)
  const trFinal = `<w:tr><w:trPr><w:cantSplit/><w:trHeight w:val="20"/><w:jc w:val="center"/></w:trPr>` +
    `<w:tc><w:tcPr><w:tcW w:w="1979" w:type="dxa"/><w:vAlign w:val="center"/></w:tcPr><w:p/></w:tc>` +
    `<w:tc><w:tcPr><w:tcW w:w="8172" w:type="dxa"/><w:gridSpan w:val="2"/><w:vAlign w:val="center"/></w:tcPr><w:p/></w:tc></w:tr>`;

  return `<w:tbl><w:tblPr><w:tblW w:w="10151" w:type="dxa"/><w:jc w:val="center"/>${BRD_TBL}` +
    `<w:tblLayout w:type="fixed"/><w:tblCellMar><w:left w:w="70" w:type="dxa"/><w:right w:w="70" w:type="dxa"/></w:tblCellMar></w:tblPr>` +
    `<w:tblGrid><w:gridCol w:w="1979"/><w:gridCol w:w="3987"/><w:gridCol w:w="4185"/></w:tblGrid>` +
    trLogo() +
    trDato('FECHA Y HORA:', fechaHora, 280) +
    trDato('MODALIDAD:', modalidad) +
    trDato('UNIDAD:', 'Educaci√≥n') +
    trDato('RESPONSABLE:', responsable) +
    trDato('RELATOR:', relator) +
    filasAsist +
    trFinal +
    `</w:tbl>`;
}

// ‚îÄ‚îÄ TABLA 2: Secci√≥n con t√≠tulo azul centrado + contenido ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function tblSeccion(titulo, texto) {
  const trTit = `<w:tr><w:tc><w:tcPr><w:tcW w:w="10207" w:type="dxa"/></w:tcPr>${pAzul(titulo,'center')}</w:tc></w:tr>`;
  const trCont = `<w:tr><w:tc><w:tcPr><w:tcW w:w="10207" w:type="dxa"/></w:tcPr>${pNormal(texto)}</w:tc></w:tr>`;
  return `<w:tbl><w:tblPr><w:tblW w:w="10207" w:type="dxa"/><w:tblInd w:w="-147" w:type="dxa"/>${BRD_TBL}</w:tblPr>` +
    `<w:tblGrid><w:gridCol w:w="10207"/></w:tblGrid>${trTit}${trCont}</w:tbl>`;
}

// ‚îÄ‚îÄ TABLA 3: Compromisos + Pr√≥xima reuni√≥n + Firmas ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function tblCompromisos(compList, proximaReunion, responsable, relator, asistList) {
  // helpers de celda con borde expl√≠cito
  function tc(w, contenido, span) {
    const spanEl = span ? `<w:gridSpan w:val="${span}"/>` : '';
    return `<w:tc><w:tcPr><w:tcW w:w="${w}" w:type="dxa"/>${spanEl}${BRD_TC}<w:vAlign w:val="center"/></w:tcPr>${contenido}</w:tc>`;
  }
  function pComp(txt, jc, azul) {
    const rpr = azul
      ? `<w:rFonts w:ascii="Arial" w:hAnsi="Arial" w:cs="Arial"/><w:b/><w:bCs/><w:color w:val="0000FF"/><w:sz w:val="22"/><w:szCs w:val="22"/>`
      : `<w:rFonts w:ascii="Arial" w:hAnsi="Arial" w:cs="Arial"/><w:sz w:val="22"/><w:szCs w:val="22"/>`;
    return `<w:p><w:pPr><w:jc w:val="${jc||'left'}"/></w:pPr><w:r><w:rPr>${rpr}</w:rPr><w:t xml:space="preserve">${escXml(txt)}</w:t></w:r></w:p>`;
  }

  // Fila encabezado compromisos
  const trHead = `<w:tr><w:trPr><w:cantSplit/><w:jc w:val="center"/></w:trPr>` +
    tc(5160, pComp('COMPROMISOS','center',true), null) +
    tc(1534, pComp('Inicio','center',true), null) +
    tc(1559, pComp('Fin','center',true), null) +
    tc(1985, pComp('RESPONSABLE','center',true), null) +
    `</w:tr>`;

  // Filas de compromisos (al menos 3 filas vac√≠as si no hay)
  let filasComp = '';
  if (compList.length) {
    filasComp = compList.map(c =>
      `<w:tr><w:trPr><w:jc w:val="center"/></w:trPr>` +
      tc(5160, pComp(c.descripcion||'','left',false)) +
      tc(1534, pComp(formatFecha(c.fechaInicio),'center',false)) +
      tc(1559, pComp(formatFecha(c.fechaFin),'center',false)) +
      tc(1985, pComp(c.responsable||'','left',false)) +
      `</w:tr>`
    ).join('');
  } else {
    for (let i=0; i<3; i++) {
      filasComp += `<w:tr><w:trPr><w:jc w:val="center"/></w:trPr>` +
        tc(5160,`<w:p/>`) + tc(1534,`<w:p/>`) + tc(1559,`<w:p/>`) + tc(1985,`<w:p/>`) + `</w:tr>`;
    }
  }

  // Fila pr√≥xima reuni√≥n (etiqueta azul subrayada | valor span 3)
  const rprProx = `<w:rFonts w:ascii="Arial" w:hAnsi="Arial" w:cs="Arial"/><w:b/><w:bCs/><w:color w:val="0000FF"/><w:sz w:val="22"/><w:szCs w:val="22"/><w:u w:val="single"/>`;
  const trProx = `<w:tr><w:trPr><w:cantSplit/><w:jc w:val="center"/></w:trPr>` +
    tc(5160, `<w:p><w:r><w:rPr>${rprProx}</w:rPr><w:t>FECHA, HORA Y MODALIDAD DE LA PR√ìXIMA REUNI√ìN:</w:t></w:r></w:p>`, null) +
    tc(5078, `<w:p><w:r><w:rPr><w:rFonts w:ascii="Arial" w:hAnsi="Arial" w:cs="Arial"/><w:sz w:val="22"/><w:szCs w:val="22"/></w:rPr><w:t xml:space="preserve">${escXml(proximaReunion||'')}</w:t></w:r></w:p>`, 3) +
    `</w:tr>`;

  // Fila vac√≠a alta (espacio pre-firmas)
  const trVacioAlto = `<w:tr><w:trPr><w:trHeight w:val="844"/><w:jc w:val="center"/></w:trPr>` +
    tc(5160,`<w:p/>`) + tc(5078,`<w:p/>`,3) + `</w:tr>`;

  // Fila de 2 firmantes
  function trFirmas(etiq1, nombre1, etiq2, nombre2) {
    return `<w:tr><w:trPr><w:trHeight w:val="570"/><w:jc w:val="center"/></w:trPr>` +
      tc(5160, pFirma(etiq1, nombre1)) +
      tc(5078, etiq2 ? pFirma(etiq2, nombre2) : `<w:p/>`, 3) +
      `</w:tr>`;
  }

  // Fila responsable+relator
  const trFirmaRR = trFirmas('Firma Responsable', responsable, 'Firma Relator', relator);

  // Filas asistentes en pares
  let filasAsistFirma = '';
  if (!asistList.length) {
    filasAsistFirma = trFirmas('', '', '', '');
  } else {
    for (let i=0; i<asistList.length; i+=2) {
      filasAsistFirma += trFirmas(
        `Firma Asistente ${i+1}`, asistList[i],
        asistList[i+1] ? `Firma Asistente ${i+2}` : '',
        asistList[i+1] || ''
      );
    }
  }

  return `<w:tbl><w:tblPr><w:tblW w:w="10238" w:type="dxa"/><w:jc w:val="center"/>${BRD_TBL}` +
    `<w:tblLayout w:type="fixed"/><w:tblCellMar><w:left w:w="70" w:type="dxa"/><w:right w:w="70" w:type="dxa"/></w:tblCellMar></w:tblPr>` +
    `<w:tblGrid><w:gridCol w:w="5160"/><w:gridCol w:w="1534"/><w:gridCol w:w="1559"/><w:gridCol w:w="1985"/></w:tblGrid>` +
    trHead + filasComp + trProx + trVacioAlto + trFirmaRR + filasAsistFirma +
    `</w:tbl>`;
}

// ‚îÄ‚îÄ Funci√≥n principal ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function generarWord(a) {
  await cargarJSZip();

  const numero    = a.numero   || '‚Äî';
  const lider     = a.lider    || '‚Äî';
  const elabora   = a.elabora  || '‚Äî';
  const fechaHora = formatFecha(a.fecha) + ', ' + (a.horaIni||'') + ' ‚Äì ' + (a.horaFin||'');
  const asistList = Array.isArray(a.asistentes) && a.asistentes.length ? a.asistentes : [];
  const compList  = Array.isArray(a.compromisos) && a.compromisos.length ? a.compromisos : [];

  const LOGO_B64 = "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";

  function b64ToArr(b64) {
    const bin = atob(b64.replace(/\s/g,''));
    const arr = new Uint8Array(bin.length);
    for (let i=0;i<bin.length;i++) arr[i]=bin.charCodeAt(i);
    return arr;
  }

  const STYLES = `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>` +
    `<w:styles xmlns:w="http://schemas.openxmlformats.org/wordprocessingml/2006/main">` +
    `<w:docDefaults><w:rPrDefault><w:rPr><w:rFonts w:ascii="Arial" w:hAnsi="Arial" w:cs="Arial"/><w:sz w:val="22"/><w:szCs w:val="22"/></w:rPr></w:rPrDefault></w:docDefaults>` +
    `<w:style w:type="paragraph" w:styleId="Ttulo1"><w:name w:val="heading 1"/>` +
    `<w:rPr><w:rFonts w:ascii="Arial" w:hAnsi="Arial"/><w:b/><w:color w:val="0000FF"/><w:sz w:val="28"/><w:szCs w:val="28"/></w:rPr></w:style>` +
    `</w:styles>`;

  const docXml = `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>` +
    `<w:document xmlns:r="http://schemas.openxmlformats.org/officeDocument/2006/relationships" ` +
    `xmlns:w="http://schemas.openxmlformats.org/wordprocessingml/2006/main" ` +
    `xmlns:wp="http://schemas.openxmlformats.org/drawingml/2006/wordprocessingDrawing" ` +
    `xmlns:w14="http://schemas.microsoft.com/office/word/2010/wordml" ` +
    `xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" mc:Ignorable="w14"><w:body>` +
    tblCabecera(numero, fechaHora, a.modalidad||'', lider, elabora, asistList) +
    `<w:p/>` +
    tblSeccion('OBJETIVO DE LA REUNI√ìN', a.objetivos) +
    `<w:p/>` +
    tblSeccion('DESARROLLO DE LOS TEMAS TRATADOS', a.desarrollo) +
    `<w:p/>` +
    tblCompromisos(compList, a.obs, lider, elabora, asistList) +
    `<w:p/>` +
    `<w:sectPr><w:pgSz w:w="12242" w:h="15842" w:code="1"/>` +
    `<w:pgMar w:top="1418" w:right="1134" w:bottom="1418" w:left="1134" w:header="709" w:footer="709" w:gutter="0"/>` +
    `<w:cols w:space="708"/><w:docGrid w:linePitch="360"/></w:sectPr>` +
    `</w:body></w:document>`;

  const RELS_ROOT = `<?xml version="1.0" encoding="UTF-8" standalone="yes"?><Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships"><Relationship Id="rId1" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/officeDocument" Target="word/document.xml"/><Relationship Id="rId2" Type="http://schemas.openxmlformats.org/package/2006/relationships/metadata/core-properties" Target="docProps/core.xml"/><Relationship Id="rId3" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/extended-properties" Target="docProps/app.xml"/></Relationships>`;
  const DOC_RELS  = `<?xml version="1.0" encoding="UTF-8" standalone="yes"?><Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships"><Relationship Id="rId6" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/styles" Target="styles.xml"/><Relationship Id="rId11" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/image" Target="media/image1.png"/></Relationships>`;
  const CT = `<?xml version="1.0" encoding="UTF-8" standalone="yes"?><Types xmlns="http://schemas.openxmlformats.org/package/2006/content-types"><Default Extension="rels" ContentType="application/vnd.openxmlformats-package.relationships+xml"/><Default Extension="xml" ContentType="application/xml"/><Default Extension="png" ContentType="image/png"/><Override PartName="/word/document.xml" ContentType="application/vnd.openxmlformats-officedocument.wordprocessingml.document.main+xml"/><Override PartName="/word/styles.xml" ContentType="application/vnd.openxmlformats-officedocument.wordprocessingml.styles+xml"/><Override PartName="/docProps/core.xml" ContentType="application/vnd.openxmlformats-package.core-properties+xml"/><Override PartName="/docProps/app.xml" ContentType="application/vnd.openxmlformats-officedocument.extended-properties+xml"/></Types>`;

  const zip = new JSZip();
  zip.file('[Content_Types].xml', CT);
  zip.file('_rels/.rels', RELS_ROOT);
  zip.file('word/document.xml', docXml);
  zip.file('word/styles.xml', STYLES);
  zip.file('word/_rels/document.xml.rels', DOC_RELS);
  zip.file('word/media/image1.png', b64ToArr(LOGO_B64));
  zip.file('docProps/app.xml', `<?xml version="1.0" encoding="UTF-8" standalone="yes"?><Properties xmlns="http://schemas.openxmlformats.org/officeDocument/2006/extended-properties"><Application>Sistema Actas Cafam</Application></Properties>`);
  zip.file('docProps/core.xml', `<?xml version="1.0" encoding="UTF-8" standalone="yes"?><cp:coreProperties xmlns:cp="http://schemas.openxmlformats.org/package/2006/metadata/core-properties" xmlns:dc="http://purl.org/dc/elements/1.1/"><dc:title>Acta No. ${escXml(numero)}</dc:title></cp:coreProperties>`);

  const blob = await zip.generateAsync({type:'blob', mimeType:'application/vnd.openxmlformats-officedocument.wordprocessingml.document'});
  const url  = URL.createObjectURL(blob);
  const link = document.createElement('a');
  link.href     = url;
  link.download = `Acta_${numero.replace(/\s/g,'')}_${(a.fecha||'').replace(/-/g,'')}.docx`;
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  URL.revokeObjectURL(url);
}
function cargarEmailJS() {
  return new Promise((resolve, reject) => {
    if (window.emailjs) { resolve(); return; }
    const s = document.createElement('script');
    s.src = 'https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js';
    s.onload = resolve;
    s.onerror = reject;
    document.head.appendChild(s);
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê ENVIAR CORREO ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function enviarCorreo(origen) {
  let actaData;
  if (origen === 'preview') {
    const actas = JSON.parse(localStorage.getItem('actas_list') || '[]');
    if (!actas.length) { showToast('Primero genera un acta antes de enviar.', 'error'); return; }
    actaData = actas[0];
  } else {
    const numero  = document.getElementById('f-numero').value.trim();
    const fecha   = document.getElementById('f-fecha').value;
    const elabora = document.getElementById('f-elabora').value.trim();
    if (!numero || !fecha || !elabora) {
      showToast('Completa al menos: N√∫mero de acta, Fecha y Relator antes de enviar.', 'error', 5000);
      return;
    }
    actaData = {
      numero, fecha,
      horaIni:    document.getElementById('f-hora-inicio').value,
      horaFin:    document.getElementById('f-hora-fin').value,
      modalidad:  document.getElementById('f-modalidad').value.trim(),
      lider:      'Carlos Arturo Castro Rojas',
      elabora,
      asistentes: Array.from(asistentesSeleccionados),
      compromisos: compromisos.map(c => c),
      objetivos:  document.getElementById('f-objetivos').value.trim(),
      desarrollo: document.getElementById('f-desarrollo').value.trim(),
      obs:        document.getElementById('f-observaciones').value.trim(),
    };
  }

  const params = buildParams(actaData);
  const btns = ['btn-enviar-form','btn-enviar-preview'].map(id => document.getElementById(id)).filter(Boolean);
  btns.forEach(b => { b.disabled = true; b.textContent = '‚è≥ Enviando...'; });
  showToast('Enviando correo y generando Word...', 'info', 0);

  try {
    // 1. Intentar generar Word primero (no depende de internet)
    showToast('Generando Word...', 'info', 0);
    try {
      await generarWord(actaData);
      showToast('Word generado. Enviando correo...', 'info', 0);
    } catch(wordErr) {
      console.error('Error Word:', wordErr);
      showToast('Error al generar Word: ' + wordErr.message, 'error', 8000);
      return;
    }

    // 2. Enviar correo
    try {
      await cargarEmailJS();
      emailjs.init(EMAILJS_PUBLIC_KEY);
      await emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, params);
      showToast('‚úÖ Word descargado y correo enviado ‚Äî Acta N¬∞ ' + actaData.numero, 'success', 7000);
    } catch(mailErr) {
      console.error('Error correo:', mailErr);
      showToast('Word descargado ‚úì ‚Äî Error correo: ' + (mailErr.text || mailErr.message || JSON.stringify(mailErr)), 'error', 10000);
    }
  } finally {
    btns.forEach(b => { b.disabled = false; b.innerHTML = 'üìß Enviar y Descargar Word'; });
  }
}

function buildParams(a) {
  const asistStr = Array.isArray(a.asistentes) && a.asistentes.length
    ? a.asistentes.join('\n')
    : 'No se registraron asistentes';

  const compStr = Array.isArray(a.compromisos) && a.compromisos.length
    ? a.compromisos.map((c, i) =>
        `${i+1}. ${c.descripcion || '‚Äî'} | Responsable: ${c.responsable || '‚Äî'} | Inicio: ${formatFecha(c.fechaInicio)} | Fin: ${formatFecha(c.fechaFin)}`
      ).join('\n')
    : 'No se registraron compromisos';

  return {
    to_email:    CORREO_DESTINO,
    numero:      a.numero || '‚Äî',
    fecha:       formatFecha(a.fecha),
    hora:        `${a.horaIni || '‚Äî'} ‚Äì ${a.horaFin || '‚Äî'}`,
    lugar:       a.modalidad || '‚Äî',
    responsable: a.lider || 'Carlos Arturo Castro Rojas',
    relator:     a.elabora || '‚Äî',
    asistentes:  asistStr,
    objetivos:   a.objetivos || '‚Äî',
    desarrollo:  a.desarrollo || '‚Äî',
    compromisos: compStr,
    proxima:     a.obs || 'No definida',
  };
}



// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê GRABADOR DE VOZ ‚Äî Groq Whisper (con pausa/reanudar) ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let mediaRecorder  = null;
let audioChunks    = [];        // chunks del segmento actual
let segmentosBlob  = [];        // blobs de cada segmento grabado
let recInterval    = null;
let recSeconds     = 0;         // segundos totales acumulados
let segSeconds     = 0;         // segundos del segmento actual
let recEstado      = 'idle';    // idle | grabando | pausado
let autoAvisado    = false;     // ya se mostr√≥ el aviso de corte pr√≥ximo

const SEG_AVISO = 19 * 60;     // 19 min ‚Üí aviso
const SEG_CORTE = 20 * 60;     // 20 min ‚Üí corte autom√°tico y reanuda

function formatTimer(s) {
  const m   = Math.floor(s / 60).toString().padStart(2,'0');
  const seg = (s % 60).toString().padStart(2,'0');
  return `${m}:${seg}`;
}

// ‚îÄ‚îÄ UI helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function recUI(estado) {
  const btnGrabar   = document.getElementById('btn-grabar');
  const btnPausar   = document.getElementById('btn-pausar');
  const btnFin      = document.getElementById('btn-finalizar');
  const timer       = document.getElementById('rec-timer');
  const label       = document.getElementById('rec-label');
  const pauseLabel  = document.getElementById('pause-label');
  const status      = document.getElementById('rec-status');
  const segs        = document.getElementById('rec-segmentos');

  if (estado === 'idle') {
    btnGrabar.classList.remove('grabando');
    btnGrabar.disabled = false;
    label.textContent  = 'Iniciar grabaci√≥n';
    btnPausar.style.display  = 'none';
    btnFin.style.display     = 'none';
    btnPausar.disabled = true;
    btnFin.disabled    = true;
    timer.classList.add('hidden');
    timer.classList.remove('pausado');
    status.textContent = 'Presiona "Iniciar grabaci√≥n" para comenzar';
    segs.classList.remove('show');
  } else if (estado === 'grabando') {
    btnGrabar.classList.add('grabando');
    btnGrabar.disabled = false;
    label.textContent  = 'Grabando...';
    btnPausar.style.display  = 'inline-flex';
    btnFin.style.display     = 'inline-flex';
    btnPausar.disabled = false;
    btnFin.disabled    = false;
    pauseLabel.textContent = 'Pausar';
    timer.classList.remove('hidden','pausado');
    status.textContent = 'üî¥ Grabando ‚Äî puedes pausar cuando quieras';
  } else if (estado === 'pausado') {
    btnGrabar.classList.remove('grabando');
    btnGrabar.disabled = false;
    label.textContent  = '‚ñ∂Ô∏è Reanudar';
    btnPausar.style.display  = 'inline-flex';
    btnFin.style.display     = 'inline-flex';
    btnPausar.disabled = true;   // no tiene sentido pausar mientras est√° pausado
    btnFin.disabled    = false;
    timer.classList.remove('hidden');
    timer.classList.add('pausado');
    const n = segmentosBlob.length;
    status.textContent = `‚è∏Ô∏è Pausado ‚Äî ${n} segmento${n!==1?'s':''} guardado${n!==1?'s':''}. Reanuda o finaliza.`;
    actualizarSegmentos();
  } else if (estado === 'procesando') {
    btnGrabar.disabled = true;
    btnPausar.disabled = true;
    btnFin.disabled    = true;
    label.textContent  = 'Procesando...';
    timer.classList.add('hidden');
  }
}

function actualizarSegmentos() {
  const el = document.getElementById('rec-segmentos');
  if (!segmentosBlob.length) { el.classList.remove('show'); return; }
  el.textContent = `üì¶ ${segmentosBlob.length} segmento${segmentosBlob.length!==1?'s':''} de audio listo${segmentosBlob.length!==1?'s':''}`;
  el.classList.add('show');
}

// ‚îÄ‚îÄ Acci√≥n principal (dispatcher) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function recAccion(accion) {
  if (accion === 'grabar') {
    if (recEstado === 'idle')   await iniciarGrabacion();
    else if (recEstado === 'pausado') reanudarGrabacion();
  } else if (accion === 'pausar') {
    pausarGrabacion();
  } else if (accion === 'finalizar') {
    await finalizarGrabacion();
  }
}

// ‚îÄ‚îÄ Iniciar ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function iniciarGrabacion() {
  try {
    const stream   = await navigator.mediaDevices.getUserMedia({ audio: true });
    const mimeType = MediaRecorder.isTypeSupported('audio/webm;codecs=opus') ? 'audio/webm;codecs=opus'
                   : MediaRecorder.isTypeSupported('audio/webm')             ? 'audio/webm'
                   : 'audio/ogg;codecs=opus';

    audioChunks  = [];
    segmentosBlob = [];
    recSeconds   = 0;

    mediaRecorder = new MediaRecorder(stream, { mimeType });
    mediaRecorder.ondataavailable = e => { if (e.data.size > 0) audioChunks.push(e.data); };

    // Al detener un segmento (pausa o fin) guardamos el blob
    mediaRecorder.onstop = () => {
      if (audioChunks.length) {
        segmentosBlob.push(new Blob(audioChunks, { type: mediaRecorder.mimeType }));
        audioChunks = [];
      }
    };

    mediaRecorder.start(500);
    recEstado = 'grabando';
    segSeconds = 0;
    autoAvisado = false;
    recUI('grabando');

    recInterval = setInterval(() => {
      recSeconds++;
      segSeconds++;
      document.getElementById('rec-timer').textContent = formatTimer(recSeconds);

      // Aviso 1 minuto antes del corte autom√°tico
      if (segSeconds === SEG_AVISO && !autoAvisado) {
        autoAvisado = true;
        mostrarAvisoCorte();
      }

      // Corte autom√°tico + reanudaci√≥n inmediata
      if (segSeconds >= SEG_CORTE) {
        cortarYReanudar();
      }
    }, 1000);

    // Guardar stream para detenerlo al final
    mediaRecorder._stream = stream;

  } catch(err) {
    console.error('Error micr√≥fono:', err);
    showToast(err.name === 'NotAllowedError'
      ? 'Permiso de micr√≥fono denegado. Habil√≠talo en el navegador.'
      : 'No se pudo acceder al micr√≥fono: ' + err.message, 'error', 7000);
  }
}

// ‚îÄ‚îÄ Pausar ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function pausarGrabacion() {
  if (!mediaRecorder || recEstado !== 'grabando') return;
  mediaRecorder.stop();     // dispara onstop ‚Üí guarda segmento
  recEstado = 'pausado';
  clearInterval(recInterval);
  recUI('pausado');
}

// ‚îÄ‚îÄ Reanudar ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function reanudarGrabacion() {
  if (!mediaRecorder || recEstado !== 'pausado') return;
  const stream   = mediaRecorder._stream;
  const mimeType = mediaRecorder.mimeType;

  audioChunks   = [];
  mediaRecorder = new MediaRecorder(stream, { mimeType });
  mediaRecorder.ondataavailable = e => { if (e.data.size > 0) audioChunks.push(e.data); };
  mediaRecorder.onstop = () => {
    if (audioChunks.length) {
      segmentosBlob.push(new Blob(audioChunks, { type: mediaRecorder.mimeType }));
      audioChunks = [];
    }
  };
  mediaRecorder._stream = stream;
  mediaRecorder.start(500);
  recEstado = 'grabando';
  segSeconds = 0;
  autoAvisado = false;
  recUI('grabando');

  recInterval = setInterval(() => {
    recSeconds++;
    segSeconds++;
    document.getElementById('rec-timer').textContent = formatTimer(recSeconds);

    // Aviso 1 minuto antes del corte autom√°tico
    if (segSeconds === SEG_AVISO && !autoAvisado) {
      autoAvisado = true;
      mostrarAvisoCorte();
    }

    // Corte autom√°tico + reanudaci√≥n inmediata
    if (segSeconds >= SEG_CORTE) {
      cortarYReanudar();
    }
  }, 1000);
}

// ‚îÄ‚îÄ Aviso de corte pr√≥ximo ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function mostrarAvisoCorte() {
  const n = segmentosBlob.length + 1;
  document.getElementById('rec-status').textContent =
    '‚ö†Ô∏è En 60 segundos se guardar√° el segmento ' + n + ' autom√°ticamente y la grabaci√≥n continuar√°.';

  // Aviso sonoro suave (beep con Web Audio API)
  try {
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const osc = ctx.createOscillator();
    const gain = ctx.createGain();
    osc.connect(gain);
    gain.connect(ctx.destination);
    osc.frequency.value = 880;
    gain.gain.setValueAtTime(0.15, ctx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.4);
    osc.start(ctx.currentTime);
    osc.stop(ctx.currentTime + 0.4);
  } catch(e) { /* navegador sin AudioContext */ }

  showToast('‚ö†Ô∏è En 60 seg se guardar√° el segmento ' + n + ' autom√°ticamente', 'info', 8000);
}

// ‚îÄ‚îÄ Corte autom√°tico + reanudaci√≥n inmediata ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function cortarYReanudar() {
  if (recEstado !== 'grabando' || !mediaRecorder) return;
  clearInterval(recInterval);

  const stream   = mediaRecorder._stream;
  const mimeType = mediaRecorder.mimeType;
  const n        = segmentosBlob.length + 1;

  // Guardar segmento actual
  mediaRecorder.stop();

  // Reanudar en cuanto el segmento est√© guardado
  setTimeout(() => {
    audioChunks   = [];
    mediaRecorder = new MediaRecorder(stream, { mimeType });
    mediaRecorder.ondataavailable = e => { if (e.data.size > 0) audioChunks.push(e.data); };
    mediaRecorder.onstop = () => {
      if (audioChunks.length) {
        segmentosBlob.push(new Blob(audioChunks, { type: mediaRecorder.mimeType }));
        audioChunks = [];
      }
    };
    mediaRecorder._stream = stream;
    mediaRecorder.start(500);
    segSeconds  = 0;
    autoAvisado = false;

    document.getElementById('rec-status').textContent =
      'üî¥ Segmento ' + n + ' guardado ‚Äî grabaci√≥n contin√∫a autom√°ticamente';
    actualizarSegmentos();

    recInterval = setInterval(() => {
      recSeconds++;
      segSeconds++;
      document.getElementById('rec-timer').textContent = formatTimer(recSeconds);
      if (segSeconds === SEG_AVISO && !autoAvisado) {
        autoAvisado = true;
        mostrarAvisoCorte();
      }
      if (segSeconds >= SEG_CORTE) {
        cortarYReanudar();
      }
    }, 1000);
  }, 400);
}

// ‚îÄ‚îÄ Finalizar ‚Üí transcribir ‚Üí redactar ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function finalizarGrabacion() {
  // Detener grabaci√≥n activa si la hay
  clearInterval(recInterval);
  if (mediaRecorder && mediaRecorder.state !== 'inactive') {
    await new Promise(res => { mediaRecorder.onstop = () => { mediaRecorder.onstop(); res(); }; mediaRecorder.stop(); });
  }
  // Peque√±a espera para que onstop procese el √∫ltimo segmento
  await new Promise(res => setTimeout(res, 300));

  // Detener tracks del micr√≥fono
  if (mediaRecorder?._stream) mediaRecorder._stream.getTracks().forEach(t => t.stop());

  recEstado = 'procesando';
  recUI('procesando');

  if (!segmentosBlob.length) {
    showToast('No hay audio grabado.', 'error', 5000);
    recEstado = 'idle'; recUI('idle'); return;
  }

  const whisperLoad = document.getElementById('whisper-loading');
  const whisperTxt  = document.getElementById('whisper-status-text');
  whisperLoad.classList.add('show');

  try {
    // ‚îÄ‚îÄ 1. Transcribir cada segmento con Whisper y ACUMULAR ‚îÄ‚îÄ
    const mimeType = segmentosBlob[0].type;
    const ext      = mimeType.includes('ogg') ? 'ogg' : 'webm';
    let nuevoTexto = '';

    for (let i = 0; i < segmentosBlob.length; i++) {
      whisperTxt.textContent = 'Transcribiendo segmento ' + (i+1) + ' de ' + segmentosBlob.length + '...';
      const fd = new FormData();
      fd.append('file', segmentosBlob[i], 'seg' + (i+1) + '.' + ext);
      fd.append('model', 'whisper-large-v3-turbo');
      fd.append('language', 'es');
      fd.append('response_format', 'text');

      const res = await fetch('https://api.groq.com/openai/v1/audio/transcriptions', {
        method: 'POST',
        headers: { 'Authorization': 'Bearer ' + GROQ_API_KEY },
        body: fd
      });

      if (!res.ok) {
        const err = await res.json().catch(() => ({}));
        throw new Error(err?.error?.message || 'Error ' + res.status + ' en segmento ' + (i+1));
      }
      const texto = (await res.text()).trim();
      if (texto) nuevoTexto += (nuevoTexto ? ' ' : '') + texto;
    }

    if (!nuevoTexto || nuevoTexto.length < 5) {
      throw new Error('No se detect√≥ audio claro en la grabaci√≥n.');
    }

    // ‚îÄ‚îÄ 2. Acumular en la variable global ‚îÄ‚îÄ
    transcripcionAcumulada += (transcripcionAcumulada ? ' ' : '') + nuevoTexto;

    // ‚îÄ‚îÄ 3. Mostrar transcripci√≥n acumulada en el panel colapsable ‚îÄ‚îÄ
    const wrap = document.getElementById('transcripcion-acumulada-wrap');
    const box  = document.getElementById('transcripcion-acumulada-box');
    wrap.style.display = 'block';
    box.textContent = transcripcionAcumulada;

    // ‚îÄ‚îÄ 4. Actualizar contador de segmentos transcritos ‚îÄ‚îÄ
    actualizarContadorSegmentos();

    // ‚îÄ‚îÄ 5. Mostrar bot√≥n de redactar grabaci√≥n ‚îÄ‚îÄ
    document.getElementById('btn-redactar-grabacion').style.display = 'inline-flex';

    const n = segmentosBlob.length;
    document.getElementById('rec-status').textContent =
      'Transcripcion completada (' + n + ' segmento' + (n!==1?'s':'') + '). Puedes seguir grabando o redactar con IA.';
    showToast('Grabacion transcrita y acumulada correctamente', 'success', 5000);

  } catch(err) {
    console.error('Error Whisper:', err);
    document.getElementById('rec-status').textContent = 'Error: ' + err.message;
    showToast('Error al transcribir: ' + err.message, 'error', 8000);
  } finally {
    whisperLoad.classList.remove('show');
    segmentosBlob = [];
    audioChunks   = [];
    mediaRecorder = null;
    recEstado     = 'idle';
    recUI('idle');
  }
}
</script>
</body>
</html>
